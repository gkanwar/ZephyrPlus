var gss=function(){"use strict";function a(a){try{var b=asn1.decodeTagLengthValueDER(a),d=b[0],e=b[1],f=b[2];if(d!==i)throw new c.Error(c.S_DEFECTIVE_TOKEN,0,"Bad token");if(f.length>0)throw new c.Error(c.S_DEFECTIVE_TOKEN,0,"Bad token");var g=asn1.OBJECT_IDENTIFIER.decodeDERPrefix(e),h=g[0],f=g[1];return{thisMech:h,innerToken:f}}catch(j){if(j instanceof asn1.Error)throw new c.Error(c.S_DEFECTIVE_TOKEN,0,j.toString());throw j}}function b(a,b){var c=b.contents().byteLength;c+=asn1.OBJECT_IDENTIFIER.encodeDERTriple(a,b),asn1.encodeLengthDER(c,b),asn1.encodeTagDER(i,b)}var c={};c.NT_USER_NAME="1.2.840.113554.1.2.1.1",c.NT_MACHINE_UID_NAME="1.2.840.113554.1.2.1.2",c.NT_STRING_UID_NAME="1.2.840.113554.1.2.1.3",c.NT_HOSTBASED_SERVICE="1.3.6.1.5.6.2",c.NT_ANONYMOUS="1.3.6.1.5.6.3",c.NT_EXPORT_NAME="1.3.6.1.5.6.4",c.S_BAD_BINDINGS=1,c.S_BAD_MECH=2,c.S_BAD_NAME=3,c.S_BAD_NAMETYPE=4,c.S_BAD_STATUS=5,c.S_BAD_SIG=6,c.S_CONTEXT_EXPIRED=7,c.S_CREDENTIALS_EXPIRED=8,c.S_DEFECTIVE_CREDENTIAL=9,c.S_DEFECTIVE_TOKEN=10,c.S_FAILURE=11,c.S_NO_CONTEXT=12,c.S_NO_CRED=13,c.S_BAD_QOP=14,c.S_UNAUTHORIZED=15,c.S_UNAVAILABLE=16,c.S_DUPLICATE_ELEMENT=17,c.S_NAME_NOT_MN=18,c.S_DUPLICATE_TOKEN=19,c.S_OLD_TOKEN=20,c.S_UNSEQ_TOKEN=21,c.S_GAP_TOKEN=22,c.KRB5_MECHANISM="1.2.840.113554.1.2.2",c.KRB5_NT_PRINCIPAL_NAME="1.2.840.113554.1.2.2.1",c.KRB5_NT_HOSTBASED_SERVICE_NAME="1.2.840.113554.1.2.1.4",c.KRB5_S_G_BAD_SERVICE_NAME=1,c.KRB5_S_G_BAD_STRING_UID=2,c.KRB5_S_G_NOUSER=3,c.KRB5_S_G_VALIDATE_FAILED=4,c.KRB5_S_G_BUFFER_ALLOC=5,c.KRB5_S_G_BAD_MSG_CTX=6,c.KRB5_S_G_WRONG_SIZE=7,c.KRB5_S_G_BAD_USAGE=8,c.KRB5_S_G_UNKNOWN_QOP=9,c.KRB5_S_KG_CCACHE_NOMATCH=10,c.KRB5_S_KG_KEYTAB_NOMATCH=11,c.KRB5_S_KG_TGT_MISSING=12,c.KRB5_S_KG_NO_SUBKEY=13,c.KRB5_S_KG_CONTEXT_ESTABLISHED=14,c.KRB5_S_KG_BAD_SIGN_TYPE=15,c.KRB5_S_KG_BAD_LENGTH=16,c.KRB5_S_KG_CTX_INCOMPLETE=17;var d=256,e=512,f=768,g=1025,h=1284;c.Error=function(a,b,c){this.major=a,this.minor=b,this.message=c},c.Error.prototype.toString=function(){return this.message},c.Name=function(a){this.principal=a},c.Name.importName=function(a,b){if(b===c.NT_EXPORT_NAME){a=arrayutils.asUint8Array(a);var d=new DataView(a.buffer,a.byteOffset,a.byteLength);if(a.length<4)throw new c.Error(c.S_BAD_NAME,0,"Bad format");if(d.getUint16(0)!=g)throw new c.Error(c.S_BAD_NAME,0,"Bad TOK_ID");var e=d.getUint16(2);if(a.length<4+e+4)throw new c.Error(c.S_BAD_NAME,0,"Bad format");try{var f=asn1.OBJECT_IDENTIFIER.decodeDER(a.subarray(4,4+e))}catch(h){if(h instanceof asn1.Error)throw new c.Error(c.S_BAD_NAME,0,h.toString());throw h}if(f!==c.KRB5_MECHANISM)throw new c.Error(c.S_BAD_MECH,0,"Only krb5 names supported");var i=d.getUint32(4+e);if(a.length!=4+e+4+i)throw new c.Error(c.S_BAD_NAME,0,"Bad length");try{return new c.Name(krb.Principal.fromString(arrayutils.toString(a.subarray(4+e+4))))}catch(h){throw new c.Error(c.S_BAD_NAME,0,h)}}else{if(b===c.NT_HOSTBASED_SERVICE||b===c.KRB5_NT_HOSTBASED_SERVICE_NAME){var j=a.indexOf("@");if(0>j)throw new c.Error(c.S_BAD_NAME,c.KRB5_S_G_BAD_SERVICE_NAME,"Default host not supported");var k=a.substring(0,j),l=a.substring(j+1);return new c.Name(new krb.Principal({nameType:krb.KRB_NT_SRV_HST,nameString:[k,l]},krb.realm))}if(b!==c.KRB5_NT_PRINCIPAL_NAME){if(b===c.NT_USER_NAME)return new c.Name(new krb.Principal({nameType:krb.KRB_NT_PRINCIPAL,nameString:[a]},krb.realm));throw new c.Error(c.S_BAD_NAMETYPE,0,"Bad nametype")}try{return new c.Name(krb.Principal.fromString(a))}catch(h){throw new c.Error(c.S_BAD_NAME,0,h)}}},c.Name.prototype.canonicalize=function(){},c.Name.prototype.exportName=function(){{var a=new asn1.Buffer;a.prependBytes(arrayutils.fromString(this.principal.toString()))}a.prependUint32(name.length);var b=asn1.OBJECT_IDENTIFIER.encodeDERTriple(c.KRB5_MECHANISM,a);return a.prependUint16(b),a.prependUint16(g),a.contents()};var i=96,j=22,k=23,l=24,m=25,n=1,o=2,p=4,q=8,r=16,s=32,t=1,u=2,v=3,w=1,x=2,y=4;return c.Context=function(a,b,d,e){if(b!==c.KRB5_MECHANISM)throw new c.Error(c.S_BAD_MECH,0,"Only krb5 is supported");this.state=t,this.credential=d,this.peer=a,this.delegation=!1,this.mutualAuthentication=e.mutualAuthentication||!1,this.replayDetection=e.replayDetection||!1,this.sequence=e.sequence||!1,this.confidentiality=e.confidentiality||!1,this.integrity=e.integrity||!1,this.bindings=e.bindings||new Uint8Array(16),this.isInitiator=!0,this.initiatorSubkey=null,this.acceptorSubkey=null,this.ctime=-1,this.cusec=-1,this.sendSeqno=-1,this.recvSeqno=-1},c.Context.prototype.initSecContext=function(g){if(this.state===t){var h=new asn1.Buffer;if(this.delegation)throw"Delegation not implemented.";var i=0;this.delegation&&(i|=n),this.mutualAuthentication&&(i|=o),this.replayDetection&&(i|=p),this.sequence&&(i|=q),this.confidentiality&&(i|=r),this.integrity&&(i|=s),h.prependUint32(i,!0);var j=h.prependBytes(this.bindings);h.prependUint32(j,!0);var k=krb.APOptions.make();this.mutualAuthentication&&(k[krb.APOptions.mutual_required]=1);var l=this.credential.makeAPReq(krb.KU_AP_REQ_AUTHENTICATOR,{cksumtype:32771,checksum:h.contents()},{apOptions:k,useSeqNumber:!0,useSubkey:!0,etypeNegotiation:!0}),m=new asn1.Buffer;return krb.AP_REQ.encodeDERTriple(l.apReq,m),m.prependUint16(d),b(c.KRB5_MECHANISM,m),this.initiatorSubkey=l.subkey,this.sendSeqno=l.seqNumber,this.recvSeqno=this.sendSeqno,this.ctime=l.authenticator.ctime.getTime(),this.cusec=l.authenticator.cusec,this.state=this.mutualAuthentication?u:v,m.contents()}if(this.state!==u)throw this.state===v?new c.Error(c.S_FAILURE,c.KRB5_S_KG_CONTEXT_ESTABLISHED,"Context already established"):"Unknown state: "+this.state;try{var w=a(g);if(w.thisMech!==c.KRB5_MECHANISM)throw new c.Error(c.S_BAD_MECH,0,"Mechanism mismatch");var x=new DataView(w.innerToken.buffer,w.innerToken.byteOffset,w.innerToken.byteLength).getUint16(0),y=w.innerToken.subarray(2);if(x===f){{krb.KRB_ERROR.decodeDER(y)}throw new c.Error(c.S_FAILURE,krb.errorCode,krb.eText)}if(x!==e)throw new c.Error(c.S_DEFECTIVE_TOKEN,0,"Bad token");var z=krb.AP_REP.decodeDER(y),A=this.credential.key.decryptAs(krb.EncAPRepPart,krb.KU_AP_REP_ENC_PART,z.encPart);if(A.ctime.getTime()!==this.ctime||A.cusec!==this.cusec)throw new c.Error(c.S_DEFECTIVE_TOKEN,c.KRB5_S_G_VALIDATE_FAILED,"Mutual authentication failed");return void 0!==A.seqNumber&&(this.recvSeqno=A.seqNumber),void 0!==A.subkey&&(this.acceptorSubkey=new krb.Key(A.subkey.keytype,A.subkey.keyvalue)),this.state=v,null}catch(B){if(B instanceof asn1.Error)throw new c.Error(c.S_DEFECTIVE_TOKEN,0,B.toString());if(B instanceof kcrypto.DecryptionError)throw new c.Error(c.S_DEFECTIVE_TOKEN,c.KRB5_S_G_VALIDATE_FAILED,"Mutual authentication failed");throw B}},c.Context.prototype.isEstablished=function(){return this.state===v},c.Context.prototype.wrap=function(a,b,d){if(0!==d&&void 0!==d)throw new c.Error(c.S_BAD_QOP,c.KRB5_S_G_UNKNOWN_QOP,"Bad QOP value");if(!this.isEstablished())throw new c.Error(c.S_NO_CONTEXT,c.KRB5_S_KG_CTX_INCOMPLETE,"Context incomplete");a=arrayutils.asUint8Array(a);var e=(this.isInitiator?0:w)|(b?x:0)|(this.acceptorSubkey?y:0),f=this.acceptorSubkey?this.acceptorSubkey:this.initiatorSubkey;if(b){var g=this.isInitiator?l:j,i=f.profile.paddingBytes(a.length+16),n=new Uint8Array(a.length+i+16);n.set(a,0);var o=n.subarray(a.length+i),p=new DataView(o.buffer,o.byteOffset,o.byteLength);p.setUint16(0,h),p.setUint8(2,e),p.setUint8(3,255),p.setUint16(4,i),p.setUint16(6,0),p.setUint32(8,this.sendSeqno/4294967296),p.setUint32(12,this.sendSeqno);var q=f.encrypt(g,n).cipher,r=new Uint8Array(16+q.length);return r.set(o,0),r.set(q,16),this.sendSeqno++,r}var g=this.isInitiator?m:k;throw"Not implemented!"},c.Context.prototype.unwrap=function(a){if(!this.isEstablished())throw new c.Error(c.S_NO_CONTEXT,c.KRB5_S_KG_CTX_INCOMPLETE,"Context incomplete");if(a=arrayutils.asUint8Array(a),a.length<16)throw new c.Error(c.S_DEFECTIVE_TOKEN,0,"Bad token");var b=new DataView(a.buffer,a.byteOffset,16);if(b.getUint16(0)!==h)throw new c.Error(c.S_DEFECTIVE_TOKEN,0,"Bad token");var d=b.getUint8(2);if((d&w)!==(this.isInitiator?w:0))throw new c.Error(c.S_BAD_SIG,0,"Bad direction");if(255!==b.getUint8(3))throw new c.Error(c.S_DEFECTIVE_TOKEN,0,"Bad token");var e=b.getUint16(4),f=b.getUint16(6),g=this.acceptorSubkey&&d&y?this.acceptorSubkey:this.initiatorSubkey,i=a.subarray(16);if(0!==f){var n=new Uint8Array(a.length);n.set(new Uint8Array(a.buffer,a.byteOffset,16));var o=new DataView(n.buffer,a.byteOffset,16);o.setUint16(6,0);for(var p=n.subarray(16),q=0;q<p.length;q++)p[(q+f)%p.length]=i[q];a=n,b=o,i=p}var r;if(!(d&x)){var s=this.isInitiator?k:m;throw"Not implemented"}var s=this.isInitiator?j:l;try{var t=g.decrypt(s,{etype:g.keytype,cipher:i})}catch(u){if(u instanceof kcrypto.DecryptionError)throw new c.Error(c.S_BAD_SIG,0,"Bad checksum")}if(t.length<e+16)throw new c.Error(c.S_DEFECTIVE_TOKEN,0,"Bad length");if(!arrayutils.equals(b,t.subarray(t.length-16)))throw new c.Error(c.S_BAD_SIG,0,"Header mismatch");if(r=t.subarray(0,t.length-e-16),this.replayDetection||this.sequence){var v=4294967296*b.getUint32(8)+b.getUint32(12);if(v!==this.recvSeqno)throw new c.Error(c.S_UNSEQ_TOKEN,0,"Bad sequence number");this.recvSeqno++}return{confidential:d&x?!0:!1,qop:0,message:new Uint8Array(r)}},c}();