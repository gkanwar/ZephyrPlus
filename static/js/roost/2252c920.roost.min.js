"use strict";function RoostEventTarget(){this.listeners_={}}function JobQueue(a){this.queue_=[],this.waiting_=!1,this.callback_=a}function Throttler(a,b){this.timeout_=b||0,this.callback_=a,this.requested_=!1,this.running_=!1,this.throttleTimer_=null,this.nextCall_=Q.defer()}function findUrls(a,b,c){var d,e=0;for(HOST_REGEX.lastIndex=0;d=HOST_REGEX.exec(a);){var f=HOST_REGEX.lastIndex-d[0].length;f>e&&c(a.substring(e,f));var g=HOST_REGEX.lastIndex;if("/"==a[g-1]){for(var h=0;g<a.length;)if("("==a[g])g++,h++;else if(")"==a[g]){if(!(h>0))break;g++,h--}else{if(!PATH_REGEX.exec(a[g]))break;g++}for(;g>f&&PUNCTUATION_REGEX.exec(a[g-1]);)g--}b(a.substring(f,g)),HOST_REGEX.lastIndex=e=g}e<a.length&&c(a.substring(e))}function longZuser(a){var b=a.indexOf("@");return 0>b?a?a+"@"+CONFIG.realm:"":b==a.length-1?a+CONFIG.realm:a}function shortZuser(a){var b=a.indexOf("@");return 0>b?a:b==a.length-1||a.substring(b+1).toLowerCase()==CONFIG.realm.toLowerCase()?a.substring(0,b):a}function zuserRealm(a){var b=a.indexOf("@");return 0>b||b==a.length-1?CONFIG.realm:a.substring(b+1)}function wrapText(a,b){b=b||70;for(var c=a.split("\n"),d=[],e=0;e<c.length;e++){e>0&&d.push("\n");for(var f=0,g=0,a=c[e],h=0;h<=a.length;h++)if(h==a.length||" "==a[h]){if(0!=g&&g+(h-f)>=b){for(d.push("\n"),g=0;f<a.length&&" "==a[f];)f++;f>h&&(h=f)}h>f&&(d.push(a.substring(f,h)),g+=h-f,f=h)}}return d.join("")}function LocalStorageWrapper(){RoostEventTarget.call(this),window.addEventListener("storage",function(){this.dispatchEvent({type:"storage"})}.bind(this))}function StorageManager(a){RoostEventTarget.call(this),this.localStorage_=a,this.data_=null,this.deferredPrincipal_=Q.defer(),this.expectedPrincipal_=null,this.disabled_=!1,this.localStorage_.addEventListener("storage",this.loadFromStorage_.bind(this)),this.loadFromStorage_()}function webathenaRequest(a,b){var c=Q.defer(),d=WinChan.open({url:a+"/#!request_ticket_v1",relay_url:a+"/relay.html",params:b},function(a,b){return a?(c.reject(a),void 0):"OK"!==b.status?(c.reject(b),void 0):(c.resolve(b.sessions.map(krb.Session.fromDict)),void 0)});return[c.promise,d]}function TicketManager(a,b){RoostEventTarget.call(this),this.webathenaRoot_=a,this.storageManager_=b,this.sessions_=null,this.waitForSession_=Q.defer(),this.pendingRequest_=null,this.storageManager_.addEventListener("change",this.loadFromStorage_.bind(this)),this.loadFromStorage_()}function stringOrNull(a){return null==a?null:String(a)}function boolOrNull(a){return null==a?null:("string"==typeof a&&(a=Number(a)),Boolean(a))}function Filter(a){this.class_key=stringOrNull(a.class_key),this.class_key_base=stringOrNull(a.class_key_base),this.instance_key=stringOrNull(a.instance_key),this.instance_key_base=stringOrNull(a.instance_key_base),this.conversation=stringOrNull(a.conversation),this.recipient=stringOrNull(a.recipient),this.sender=stringOrNull(a.sender),this.is_personal=boolOrNull(a.is_personal)}function UserInfoConflict(){}function UserInfo(a){RoostEventTarget.call(this),this.api_=a,this.base_=null,this.baseVersion_=-1,this.local_=null,this.pending_=null,this.throttler_=new Throttler(this.doUpdate_.bind(this),USER_INFO_UPDATE_THROTTLE),this.ready_=Q.defer(),this.api_.addEventListener("connect",this.onConnect_.bind(this)),this.onConnect_()}function mergeScrollStateDiff(a,b){var c={remove:{},add:a.add.slice(0)};for(var d in a.remove)c.remove[d]=1;for(var d in b.remove)c.remove[d]=1;return c.add=c.add.filter(function(a){return!b.remove[a.id]}),c.add=c.add.concat(b.add),c.add.length>USER_INFO_MAX_SCROLL_STATES&&(c.add=c.add.slice(c.add.length-USER_INFO_MAX_SCROLL_STATES)),c}function NetworkError(a){this.msg=a}function HttpError(a,b,c){this.status=a,this.statusText=b,this.responseText=c}function corsRequest(a,b,c){var d=new XMLHttpRequest,e=!1;if("withCredentials"in d)d.open(a,b,!0);else{if("undefined"==typeof XDomainRequest)return Q.reject("CORS not supported.");d=new XDomainRequest,d.open(a,b),e=!0}var f=Q.defer();if(d.onload=function(){e||200==this.status?f.resolve(this.responseText):this.status?f.reject(new HttpError(this.status,this.statusText,this.responseText)):f.reject(new NetworkError)},d.onerror=function(){f.reject("Request failed")},e&&(d.onprogress=function(){},d.ontimeout=function(){}),e)setTimeout(function(){void 0!==c?d.send(JSON.stringify(c)):d.send(),c=void 0},0);else{if(void 0!==c){d.setRequestHeader("Content-Type","text/plain");var g,h=JSON.stringify(c);if(window.FormData&&(g=APPLE_WEBKIT_RE.exec(navigator.userAgent))){var i=Number(g[1]),j=Number(g[2]);i>537||537==i&&j>=4?d.send(arrayutils.fromString(h)):d.send(arrayutils.fromString(h).buffer)}else d.send(h)}else d.send();c=void 0}return f.promise}function RoostSocket(a){RoostEventTarget.call(this),this.sockJS_=a,this.sockJS_.addEventListener("message",this.onMessage_.bind(this)),this.sockJS_.addEventListener("close",this.onClose_.bind(this)),this.ready_=!1,this.pingVisible_=null,this.pingHidden_=null,this.pongTimer_=null,this.onVisibilityChangeCb_=this.onVisibilityChange_.bind(this),document.addEventListener("visibilitychange",this.onVisibilityChangeCb_)}function generateId(){for(var a=[],b=0;10>b;b++)a.push(String.fromCharCode(CHARCODE_a+Math.floor(26*Math.random())));return a.join("")}function API(a,b,c,d){RoostEventTarget.call(this),this.clientId_=generateId(),this.urlBase_=a,this.storageManager_=c,this.ticketManager_=d,this.peer_=gss.Name.importName(b,gss.KRB5_NT_PRINCIPAL_NAME),this.token_=null,this.tokenDeferred_=Q.defer(),this.tokenPending_=!1,this.socket_=null,this.socketPending_=!1,this.reconnectDelay_=RECONNECT_DELAY,this.reconnectTries_=RECONNECT_TRIES,this.nextTailId_=1,setTimeout(this.tryConnectSocket_.bind(this),0),setTimeout(this.checkInnerDemon_.bind(this),0),this.loadTokenFromStorage_(),this.storageManager_.addEventListener("change",this.loadTokenFromStorage_.bind(this)),this.userInfo_=new UserInfo(this),window.setInterval(this.checkExpiredToken_.bind(this),TOKEN_REFRESH_TIMER),window.addEventListener("online",this.tryConnectSocket_.bind(this))}function MessageModel(a){this.api_=a}function MessageTail(a,b,c,d,e){this.model_=a,this.lastSent_=b,this.inclusive_=c,this.messagesSentTotal_=0,this.messagesSentRecent_=0,this.messagesWanted_=0,this.filter_=d,this.cb_=e,this.tailId_=null,this.lastExtend_=0,this.connectedCb_=this.onConnect_.bind(this),this.disconnectCb_=this.onDisconnect_.bind(this),this.messagesCb_=this.onMessages_.bind(this),this.model_.api_.addEventListener("connect",this.connectedCb_),this.onConnect_()}function MessageReverseTail(a,b,c,d){this.model_=a,this.start_=b,this.messagesSent_=0,this.messagesWanted_=0,this.filter_=c,this.cb_=d,this.pending_=!1,this.throttleTimer_=null,this.throttle_=500,this.reconnectCb_=this.onReconnect_.bind(this),this.model_.api_.addEventListener("connect",this.reconnectCb_)}function nextChar(a,b,c){return c.lastIndex=b,c.test(a)?c.lastIndex-1:-1}function findTagName(a,b){var c=/[a-zA-Z0-9_]*/g;return c.lastIndex=b,c.exec(a)[0]||""}function ZtextNode(a,b,c,d){this.tag=a,this.open=b,this.close=c,this.children=d}function parseZtextHelper(a,b,c,d){function e(a){""!=a&&(f.length&&"string"==typeof f[f.length-1]?f[f.length-1]+=a:f.push(a))}for(var f=[];b<a.length;){var g=nextChar(a,b,c);if(0>g)e(a.substring(b)),b=a.length;else{if(e(a.substring(b,g)),"@"!=a[g]){b=g+1;break}if("@"!=a[g+1]){0>=d&&(e("@"),b++);var h=findTagName(a,g+1),i=a[g+1+h.length];if(i in OTHERSIDE){var j=OTHERSIDE[i][0],k=OTHERSIDE[i][1],l=parseZtextHelper(a,g+1+h.length+1,k,d-1);f.push(new ZtextNode(h,i,j,l.parsed)),b=l.startInd}else e("@"+h),b=g+1+h.length}else e("@"),b=g+2}}return{parsed:f,startInd:b}}function parseZtext(a){return parseZtextHelper(a,0,/@/g,MAX_ZTEXT_DEPTH).parsed}function ztextToDOM(a,b){null==b&&(b=document.createDocumentFragment());for(var c=b,d=0;d<a.length;d++){var e=a[d];if("string"==typeof e)findUrls(e,function(a){var b=document.createElement("a");b.href=a,b.target="_blank",b.rel="nofollow",b.appendChild(document.createTextNode(a)),c.appendChild(b)},function(a){c.appendChild(document.createTextNode(a))});else{var f=e.tag.toLowerCase();if(""==f)c.appendChild(ztextToDOM(e.children));else if("b"==f||"bold"==f){var g=document.createElement("b");ztextToDOM(e.children,g),c.appendChild(g)}else if("i"==f||"italic"==f){var g=document.createElement("i");ztextToDOM(e.children,g),c.appendChild(g)}else if("color"==f&&1==e.children.length&&"string"==typeof e.children[0]){var h=e.children[0];h in COLOR_MAP&&(h=COLOR_MAP[h]);var g=document.createElement("span");/^(?:[a-zA-Z]+|#[0-9a-fA-F]{3}|#[0-9a-fA-F]{6})$/.test(h)&&(g.style.color=h),b.appendChild(g),c=g}else c.appendChild(document.createTextNode("@"+e.tag+e.open)),ztextToDOM(e.children,c),c.appendChild(document.createTextNode(e.close))}}return b}var CONFIG={realm:"ATHENA.MIT.EDU",server:"https://roost-api.mit.edu",serverPrincipal:"HTTP/roost-api.mit.edu",webathena:"https://webathena.mit.edu"};"undefined"==typeof WeakMap&&function(){var a=Object.defineProperty,b=Date.now()%1e9,c=function(){this.name="__st"+(1e9*Math.random()>>>0)+(b++ +"__")};c.prototype={set:function(b,c){var d=b[this.name];d&&d[0]===b?d[1]=c:a(b,this.name,{value:[b,c],writable:!0})},get:function(a){var b;return(b=a[this.name])&&b[0]===a?b[1]:void 0},"delete":function(a){this.set(a,void 0)}},window.WeakMap=c}(),function(a){function b(a){u.push(a),t||(t=!0,q(d))}function c(a){return window.ShadowDOMPolyfill&&window.ShadowDOMPolyfill.wrapIfNeeded(a)||a}function d(){t=!1;var a=u;u=[],a.sort(function(a,b){return a.uid_-b.uid_});var b=!1;a.forEach(function(a){var c=a.takeRecords();e(a),c.length&&(a.callback_(c,a),b=!0)}),b&&d()}function e(a){a.nodes_.forEach(function(b){var c=p.get(b);c&&c.forEach(function(b){b.observer===a&&b.removeTransientObservers()})})}function f(a,b){for(var c=a;c;c=c.parentNode){var d=p.get(c);if(d)for(var e=0;e<d.length;e++){var f=d[e],g=f.options;if(c===a||g.subtree){var h=b(g);h&&f.enqueue(h)}}}}function g(a){this.callback_=a,this.nodes_=[],this.records_=[],this.uid_=++v}function h(a,b){this.type=a,this.target=b,this.addedNodes=[],this.removedNodes=[],this.previousSibling=null,this.nextSibling=null,this.attributeName=null,this.attributeNamespace=null,this.oldValue=null}function i(a){var b=new h(a.type,a.target);return b.addedNodes=a.addedNodes.slice(),b.removedNodes=a.removedNodes.slice(),b.previousSibling=a.previousSibling,b.nextSibling=a.nextSibling,b.attributeName=a.attributeName,b.attributeNamespace=a.attributeNamespace,b.oldValue=a.oldValue,b}function j(a,b){return w=new h(a,b)}function k(a){return x?x:(x=i(w),x.oldValue=a,x)}function l(){w=x=void 0}function m(a){return a===x||a===w}function n(a,b){return a===b?a:x&&m(a)?x:null}function o(a,b,c){this.observer=a,this.target=b,this.options=c,this.transientObservedNodes=[]}var p=new WeakMap,q=window.msSetImmediate;if(!q){var r=[],s=String(Math.random());window.addEventListener("message",function(a){if(a.data===s){var b=r;r=[],b.forEach(function(a){a()})}}),q=function(a){r.push(a),window.postMessage(s,"*")}}var t=!1,u=[],v=0;g.setSafeImmediate=function(a){var b=function(){t?setTimeout(b,0):a()};setTimeout(b,0)},g.observersScheduled=function(){return t},g.prototype={observe:function(a,b){if(a=c(a),!b.childList&&!b.attributes&&!b.characterData||b.attributeOldValue&&!b.attributes||b.attributeFilter&&b.attributeFilter.length&&!b.attributes||b.characterDataOldValue&&!b.characterData)throw new SyntaxError;var d=p.get(a);d||p.set(a,d=[]);for(var e,f=0;f<d.length;f++)if(d[f].observer===this){e=d[f],e.removeListeners(),e.options=b;break}e||(e=new o(this,a,b),d.push(e),this.nodes_.push(a)),e.addListeners()},disconnect:function(){this.nodes_.forEach(function(a){for(var b=p.get(a),c=0;c<b.length;c++){var d=b[c];if(d.observer===this){d.removeListeners(),b.splice(c,1);break}}},this),this.records_=[]},takeRecords:function(){var a=this.records_;return this.records_=[],a}};var w,x;o.prototype={enqueue:function(a){var c=this.observer.records_,d=c.length;if(c.length>0){var e=c[d-1],f=n(e,a);if(f)return c[d-1]=f,void 0}else b(this.observer);c[d]=a},addListeners:function(){this.addListeners_(this.target)},addListeners_:function(a){var b=this.options;b.attributes&&a.addEventListener("DOMAttrModified",this,!0),b.characterData&&a.addEventListener("DOMCharacterDataModified",this,!0),b.childList&&a.addEventListener("DOMNodeInserted",this,!0),(b.childList||b.subtree)&&a.addEventListener("DOMNodeRemoved",this,!0)},removeListeners:function(){this.removeListeners_(this.target)},removeListeners_:function(a){var b=this.options;b.attributes&&a.removeEventListener("DOMAttrModified",this,!0),b.characterData&&a.removeEventListener("DOMCharacterDataModified",this,!0),b.childList&&a.removeEventListener("DOMNodeInserted",this,!0),(b.childList||b.subtree)&&a.removeEventListener("DOMNodeRemoved",this,!0)},addTransientObserver:function(a){if(a!==this.target){this.addListeners_(a),this.transientObservedNodes.push(a);var b=p.get(a);b||p.set(a,b=[]),b.push(this)}},removeTransientObservers:function(){var a=this.transientObservedNodes;this.transientObservedNodes=[],a.forEach(function(a){this.removeListeners_(a);for(var b=p.get(a),c=0;c<b.length;c++)if(b[c]===this){b.splice(c,1);break}},this)},handleEvent:function(a){switch(a.stopImmediatePropagation(),a.type){case"DOMAttrModified":var b=a.attrName,c=a.relatedNode.namespaceURI,d=a.target,e=new j("attributes",d);e.attributeName=b,e.attributeNamespace=c;var g=a.attrChange===MutationEvent.ADDITION?null:a.prevValue;f(d,function(a){return!a.attributes||a.attributeFilter&&a.attributeFilter.length&&-1===a.attributeFilter.indexOf(b)&&-1===a.attributeFilter.indexOf(c)?void 0:a.attributeOldValue?k(g):e});break;case"DOMCharacterDataModified":var d=a.target,e=j("characterData",d),g=a.prevValue;f(d,function(a){return a.characterData?a.characterDataOldValue?k(g):e:void 0});break;case"DOMNodeRemoved":this.addTransientObserver(a.target);case"DOMNodeInserted":var h,i,d=a.relatedNode,m=a.target;"DOMNodeInserted"===a.type?(h=[m],i=[]):(h=[],i=[m]);var n=m.previousSibling,o=m.nextSibling,e=j("childList",d);e.addedNodes=h,e.removedNodes=i,e.previousSibling=n,e.nextSibling=o,f(d,function(a){return a.childList?e:void 0})}l()}},a.JsMutationObserver=g,!a.MutationObserver&&a.WebKitMutationObserver&&(a.MutationObserver=a.WebKitMutationObserver),a.MutationObserver||(a.MutationObserver=g)}(this),/*! @source http://purl.eligrey.com/github/classList.js/blob/master/classList.js*/
"undefined"==typeof document||"classList"in document.createElement("a")||function(a){if("HTMLElement"in a||"Element"in a){var b="classList",c="prototype",d=(a.HTMLElement||a.Element)[c],e=Object,f=String[c].trim||function(){return this.replace(/^\s+|\s+$/g,"")},g=Array[c].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},h=function(a,b){this.name=a,this.code=DOMException[a],this.message=b},i=function(a,b){if(""===b)throw new h("SYNTAX_ERR","An invalid or illegal string was specified");if(/\s/.test(b))throw new h("INVALID_CHARACTER_ERR","String contains an invalid character");return g.call(a,b)},j=function(a){for(var b=f.call(a.className),c=b?b.split(/\s+/):[],d=0,e=c.length;e>d;d++)this.push(c[d]);this._updateClassName=function(){a.className=this.toString()}},k=j[c]=[],l=function(){return new j(this)};if(h[c]=Error[c],k.item=function(a){return this[a]||null},k.contains=function(a){return a+="",-1!==i(this,a)},k.add=function(){var a,b=arguments,c=0,d=b.length,e=!1;do a=b[c]+"",-1===i(this,a)&&(this.push(a),e=!0);while(++c<d);e&&this._updateClassName()},k.remove=function(){var a,b=arguments,c=0,d=b.length,e=!1;do{a=b[c]+"";var f=i(this,a);-1!==f&&(this.splice(f,1),e=!0)}while(++c<d);e&&this._updateClassName()},k.toggle=function(a,b){a+="";var c=this.contains(a),d=c?b!==!0&&"remove":b!==!1&&"add";return d&&this[d](a),!c},k.toString=function(){return this.join(" ")},e.defineProperty){var m={get:l,enumerable:!0,configurable:!0};try{e.defineProperty(d,b,m)}catch(n){-2146823252===n.number&&(m.enumerable=!1,e.defineProperty(d,b,m))}}else e[c].__defineGetter__&&d.__defineGetter__(b,l)}}(self),function(){var a,b,c;"undefined"!=typeof document.hidden||("undefined"!=typeof document.mozHidden?(a="mozHidden",b="mozVisibilityState",c="mozvisibilitychange"):"undefined"!=typeof document.webkitHidden&&(a="webkitHidden",b="webkitVisibilityState",c="webkitvisibilitychange")),a&&(Object.defineProperty(document,"hidden",{configurable:!0,enumerable:!0,get:function(){return this[a]}}),Object.defineProperty(document,"visibilityState",{configurable:!0,enumerable:!0,get:function(){return this[b]}}),document.addEventListener(c,function(a){var a=document.createEvent("Event");a.initEvent("visibilitychange",!0,!1),document.dispatchEvent(a)}))}(),RoostEventTarget.prototype.indexOfListener_=function(a,b){if(!(a in this.listeners_))return-1;for(var c=0;c<this.listeners_[a].length;c++)if(this.listeners_[a][c].cb===b)return c;return-1},RoostEventTarget.prototype.addEventListener=function(a,b){a in this.listeners_||(this.listeners_[a]=[]),-1==this.indexOfListener_(a,b)&&this.listeners_[a].push({cb:b,doomed:!1})},RoostEventTarget.prototype.removeEventListener=function(a,b){if(a in this.listeners_){var c=this.indexOfListener_(a,b);-1!=c&&(this.listeners_[a][c].doomed=!0,this.listeners_[a].splice(c,1))}},RoostEventTarget.prototype.dispatchEvent=function(a){var b=a.type;if(b in this.listeners_)for(var c=this.listeners_[b].slice(0),d=0;d<c.length;d++)c[d].doomed||c[d].cb.call(this,a)};var timespan={};timespan.milliseconds=function(a){return a},timespan.seconds=function(a){return 1e3*a},timespan.minutes=function(a){return 1e3*60*a},timespan.hours=function(a){return 1e3*60*60*a},timespan.days=function(a){return 1e3*60*60*24*a},JobQueue.prototype.addJob=function(a){return this.queue_.push(a),this.processQueue_(),this.queue_.length},JobQueue.prototype.processQueue_=function(){if(!this.waiting_&&0!=this.queue_.length){var a=this.queue_[0];this.waiting_=!0,this.callback_(a).then(function(){this.queue_.shift(),this.waiting_=!1,this.processQueue_()}.bind(this)).done()}},Throttler.prototype.processState_=function(){this.requested_&&!this.running_&&null==this.throttleTimer_&&(this.throttleTimer_=setTimeout(function(){this.throttleTimer_=null,this.processState_()}.bind(this),this.timeout_),this.requested_=!1,this.running_=!0,this.nextCall_.resolve(Q.fcall(this.callback_).finally(function(){this.running_=!1,this.processState_()}.bind(this))),this.nextCall_=Q.defer())},Throttler.prototype.request=function(a){return a=a||{},this.requested_=!0,a.noThrottle&&null!=this.throttleTimer_&&(clearTimeout(this.throttleTimer_),this.throttleTimer_=null),setTimeout(this.processState_.bind(this),0),this.nextCall_.promise};var HOST_REGEX=new RegExp("\\b(?:https|http):\\/\\/(?:\\[(?:[0-9a-f]{1,4}(?::[0-9a-f]{1,4})*)?(?:::(?:[0-9a-f]{1,4}(?::[0-9a-f]{1,4})*)?)?(?::[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})?\\]|[-a-zA-Z0-9_\\u00a0-\\uefffd]+(?:\\.[-a-zA-Z0-9_\\u00a0-\\uefffd]+)*)(?::[0-9]+)?/?","g"),PATH_REGEX=/[^\s()<>]/,PUNCTUATION_REGEX=/[`!\[\]{};:'".,?«»“”‘’]/;LocalStorageWrapper.prototype=Object.create(RoostEventTarget.prototype),LocalStorageWrapper.prototype.clear=function(){localStorage.clear()},LocalStorageWrapper.prototype.getItem=function(a){return localStorage.getItem(a)},LocalStorageWrapper.prototype.setItem=function(a,b){localStorage.setItem(a,b)},StorageManager.prototype=Object.create(RoostEventTarget.prototype),StorageManager.prototype.principalCheck_=function(a){if(null==this.expectedPrincipal_)this.expectedPrincipal_=a,this.deferredPrincipal_.resolve(a);else if(this.expectedPrincipal_!=a)return this.disabled_=!0,this.dispatchEvent({type:"usermismatch",actual:a,expected:this.expectedPrincipal_}),!1;return!0},StorageManager.prototype.loadFromStorage_=function(){var a=this.localStorage_.getItem("roostData");if(a){var b=JSON.parse(a);this.principalCheck_(b.principal)&&(this.data_=b,this.dispatchEvent({type:"change"}))}},StorageManager.prototype.data=function(){return this.data_},StorageManager.prototype.isLoggedIn=function(){return null!=this.expectedPrincipal_},StorageManager.prototype.principal=function(){return this.deferredPrincipal_.promise},StorageManager.prototype.saveTickets=function(a){var b=a.server.client.toString();if(a.zephyr.client.toString()!==b)throw"Zephyr and server tickets don't match!";if(!this.disabled_){var c=this.principalCheck_(b);return this.data_=c?this.data_||{}:{},this.data_.principal=b,this.data_.sessions={server:a.server.toDict(),zephyr:a.zephyr.toDict()},this.localStorage_.setItem("roostData",JSON.stringify(this.data_)),this.dispatchEvent({type:"change"}),c}},StorageManager.prototype.saveToken=function(a,b,c){if(!this.disabled_){var d=this.principalCheck_(a);return this.data_=d?this.data_||{}:{},this.data_.principal=a,this.data_.token={value:b,expires:c},this.localStorage_.setItem("roostData",JSON.stringify(this.data_)),this.dispatchEvent({type:"change"}),d}};var MINIMUM_LIFETIME=timespan.minutes(10);TicketManager.prototype=Object.create(RoostEventTarget.prototype),TicketManager.prototype.loadFromStorage_=function(){var a=this.storageManager_.data();if(a&&a.sessions){var b={server:krb.Session.fromDict(a.sessions.server),zephyr:krb.Session.fromDict(a.sessions.zephyr)};b.server.timeRemaining()<=MINIMUM_LIFETIME||b.zephyr.timeRemaining()<=MINIMUM_LIFETIME||this.handleNewSessions_(b)}},TicketManager.prototype.refreshInteractive_=function(){if(this.pendingRequest_)return this.pendingRequest_.focus(),void 0;var a=webathenaRequest(this.webathenaRoot_,{services:[{principal:["HTTP","roost-api.mit.edu"],realm:CONFIG.realm},{principal:["zephyr","zephyr"],realm:CONFIG.realm}]}),b=a[0],c=a[1];this.pendingRequest_=c,b.then(function(a){this.pendingRequest_=null;var b={server:a[0],zephyr:a[1]};this.storageManager_.saveTickets(b)&&this.handleNewSessions_(b)}.bind(this),function(a){this.pendingRequest_=null,this.dispatchEvent({type:"webathena-error",error:a})}.bind(this)).done()},TicketManager.prototype.handleNewSessions_=function(a){this.sessions_=a,this.waitForSession_.resolve(a),this.waitForSession_=Q.defer()},TicketManager.prototype.getCachedTicket=function(a){return this.sessions_&&this.sessions_[a].timeRemaining()>MINIMUM_LIFETIME?this.sessions_[a]:null},TicketManager.prototype.refreshTickets=function(a,b){a=a||{},b=b||{},(null==this.getCachedTicket("server")||null==this.getCachedTicket("zephyr"))&&(a.interactive?this.refreshInteractive_():setTimeout(function(){this.dispatchEvent({type:"ticket-needed",data:b})}.bind(this)))},TicketManager.prototype.getTicket=function(a){var b=this.getCachedTicket(a);return null!=b?Q(b):this.waitForSession_.promise.then(function(b){return b[a]})},TicketManager.prototype.expireTickets=function(){this.sessions_.zephyr.endtime=new Date,this.sessions_.server.endtime=new Date,this.storageManager_.saveTickets(this.sessions_)&&this.handleNewSessions_(this.sessions_)};var baseString=function(a){return a.replace(/^(?:un)*/,"").replace(/(?:\.d)*$/,"")};Filter.FIELDS=["class_key","class_key_base","instance_key","instance_key_base","conversation","recipient","sender","is_personal"],Filter.prototype.matchesMessage=function(a){return null!=this.class_key&&this.class_key!==a.classKey?!1:null!=this.class_key_base&&this.class_key_base!==a.classKeyBase?!1:null!=this.instance_key&&this.instance_key!==a.instanceKey?!1:null!=this.instance_key_base&&this.instance_key_base!==a.instanceKeyBase?!1:null!=this.conversation&&this.conversation!==a.conversation?!1:null!=this.recipient&&this.recipient!==a.recipient?!1:null!=this.sender&&this.sender!==a.sender?!1:null!=this.is_personal&&this.is_personal!==a.isPersonal?!1:!0},Filter.prototype.isStricterThan=function(a){if(null!=a.conversation&&this.conversation!==a.conversation)return!1;if(null!=a.recipient&&this.recipient!==a.recipient)return!1;if(null!=a.sender&&this.sender!==a.sender)return!1;if(null!=a.is_personal&&this.is_personal!==a.is_personal)return!1;if(null!=a.class_key&&this.class_key!==a.class_key)return!1;if(null!=a.instance_key&&this.instance_key!==a.instance_key)return!1;if(null!=a.class_key_base)if(null!=this.class_key_base){if(this.class_key_base!==a.class_key_base)return!1}else if(null==this.class_key||baseString(this.class_key)!==a.class_key_base)return!1;if(null!=a.instance_key_base)if(null!=this.instance_key_base){if(this.instance_key_base!==a.instance_key_base)return!1}else if(null==this.instance_key||baseString(this.instance_key)!==a.instance_key_base)return!1;return!0},Filter.prototype.toDict=function(){var a={};return Filter.FIELDS.forEach(function(b){null!=this[b]&&(a[b]=this[b])},this),a};var USER_INFO_UPDATE_THROTTLE=timespan.seconds(3),USER_INFO_MAX_SCROLL_STATES=5;UserInfo.prototype=Object.create(RoostEventTarget.prototype),UserInfo.prototype.onConnect_=function(){this.loadInfo_().done();var a=this.api_.socket();a&&a.addEventListener("info-changed",function(a){this.handleNewInfo_(a.info,a.version)}.bind(this))},UserInfo.prototype.handleNewInfo_=function(a,b,c){if(!(this.baseVersion_>=b)){try{this.base_=JSON.parse(a)}catch(d){window.console&&console.log&&console.log("Error parsing user info",d),this.base_={}}"object"==typeof this.base_&&this.base_||(this.base_={}),this.baseVersion_=b,Q.isPending(this.ready_.promise)&&this.ready_.resolve(),c||setTimeout(function(){this.dispatchEvent({type:"change"})}.bind(this))}},UserInfo.prototype.loadInfo_=function(){return this.api_.get("/v1/info").then(function(a){this.handleNewInfo_(a.info,a.version)}.bind(this))},UserInfo.prototype.ready=function(){return this.ready_.promise},UserInfo.prototype.get=function(a){if(this.baseVersion_<0)throw"User info not loaded!";return this.local_&&a in this.local_?this.local_[a]:this.pending_&&a in this.pending_?this.pending_[a]:this.base_[a]},UserInfo.prototype.scrollStates=function(){var a={remove:{},add:this.base_.scrollStates||[]};this.pending_&&(a=mergeScrollStateDiff(a,this.pending_.scrollStates)),this.local_&&(a=mergeScrollStateDiff(a,this.local_.scrollStates));var b=a.add.slice(0);return b.reverse(),b},UserInfo.prototype.ensureLocal_=function(){this.local_||(this.local_={scrollStates:{remove:{},add:[]}})},UserInfo.prototype.set=function(a,b){if(this.baseVersion_<0)throw"User info not loaded!";this.ensureLocal_(),this.local_[a]=b,setTimeout(function(){this.dispatchEvent({type:"change"})}.bind(this)),this.throttler_.request()},UserInfo.prototype.replaceScrollState=function(a,b){if(this.baseVersion_<0)throw"User info not loaded!";this.ensureLocal_();var c={remove:{},add:b?[b]:[]};a&&(c.remove[a.id]=1),this.local_.scrollStates=mergeScrollStateDiff(this.local_.scrollStates,c),setTimeout(function(){this.dispatchEvent({type:"change"})}.bind(this)),this.throttler_.request()},UserInfo.prototype.mergeLocalAndPending_=function(){if(this.local_){for(var a in this.local_)this.local_.hasOwnProperty(a)&&"scrollStates"!=a&&(this.pending_[a]=this.local_[a]);this.pending_.scrollStates=mergeScrollStateDiff(this.pending_.scrollStates,this.local_.scrollStates)}this.local_=this.pending_,this.pending_=null},UserInfo.prototype.doUpdate_=function(){this.pending_=this.local_,this.local_=null;var a={};for(var b in this.base_)this.base_.hasOwnProperty(b)&&(a[b]=this.base_[b]);a.scrollStates||(a.scrollStates=[]);for(var b in this.pending_)this.pending_.hasOwnProperty(b)&&"scrollStates"!=b&&(a[b]=this.pending_[b]);a.scrollStates=mergeScrollStateDiff({remove:{},add:a.scrollStates},this.pending_.scrollStates).add;var c=this.baseVersion_+1,d=angular.toJson(a),e=angular.toJson(this.base_);return e===d?(this.pending_=null,void 0):this.api_.post("/v1/info",{expectedVersion:this.baseVersion_,info:d}).then(function(a){return a.updated?(this.pending_=null,this.handleNewInfo_(d,c,!0),void 0):(this.mergeLocalAndPending_(),this.handleNewInfo_(a.info,a.version),this.doUpdate_())}.bind(this),function(a){throw this.mergeLocalAndPending_(),a}.bind(this))};var RECONNECT_DELAY=timespan.milliseconds(500),RECONNECT_TRIES=10,TOKEN_REFRESH_TIMER=timespan.minutes(30),TOKEN_RENEW_SOFT=timespan.days(1),TOKEN_RENEW_HARD=timespan.minutes(5),INNER_DEMON_CHECK_TIMER=timespan.minutes(15),SOCKET_PING_TIMER_VISIBLE=timespan.seconds(5),SOCKET_PING_TIMER_HIDDEN=timespan.minutes(1),SOCKET_PONG_TIMEOUT=timespan.seconds(5),APPLE_WEBKIT_RE=/\bAppleWebKit\/([0-9]+)\.([0-9]+)\b/;NetworkError.prototype.toString=function(){return"Network error"},HttpError.prototype.toString=function(){return this.responseText},"undefined"==typeof document.hidden&&window.console&&console.log&&console.log("Page visibility API not supported."),RoostSocket.prototype=Object.create(RoostEventTarget.prototype),RoostSocket.prototype.sockJS=function(){return this.sockJS_},RoostSocket.prototype.onMessage_=function(a){null!=this.pongTimer_&&(clearTimeout(this.pongTimer_),this.pongTimer_=null);var b=JSON.parse(a.data);"ready"===b.type&&(this.ready_=!0,this.onVisibilityChangeCb_()),this.dispatchEvent(b)},RoostSocket.prototype.send=function(a){this.sockJS_.send(JSON.stringify(a))},RoostSocket.prototype.onVisibilityChange_=function(){this.ready_&&(document.hidden&&null==this.pingHidden_||!document.hidden&&null==this.pingVisible_)&&this.sendPing_()},RoostSocket.prototype.sendPing_=function(){this.send({type:"ping"}),null==this.pongTimer_&&(this.pongTimer_=setTimeout(function(){window.console&&console.log&&console.log("No response from server"),this.sockJS_.close()}.bind(this),SOCKET_PONG_TIMEOUT)),null!=this.pingVisible_&&clearTimeout(this.pingVisible_),this.pingVisible_=setTimeout(function(){this.pingVisible_=null,this.onVisibilityChange_()}.bind(this),SOCKET_PING_TIMER_VISIBLE),null!=this.pingHidden_&&clearTimeout(this.pingHidden_),this.pingHidden_=setTimeout(function(){this.pingHidden_=null,this.onVisibilityChange_()}.bind(this),SOCKET_PING_TIMER_HIDDEN)},RoostSocket.prototype.onClose_=function(){null!=this.pongTimer_&&(clearTimeout(this.pongTimer_),this.pongTimer_=null),null!=this.pingVisible_&&(clearTimeout(this.pingVisible_),this.pingVisible_=null),null!=this.pingHidden_&&(clearTimeout(this.pingHidden_),this.pingHidden_=null),document.removeEventListener("visibilitychange",this.onVisibilityChangeCb_),this.ready_=!1};var CHARCODE_a="a".charCodeAt(0);API.prototype=Object.create(RoostEventTarget.prototype),API.prototype.userInfo=function(){return this.userInfo_},API.prototype.handleNewToken_=function(a,b){this.token_={value:a,expires:b},this.tokenDeferred_.resolve(a),this.tokenDeferred_=Q.defer()},API.prototype.loadTokenFromStorage_=function(){var a=this.storageManager_.data();a&&a.token&&a.token.expires-(new Date).getTime()>TOKEN_RENEW_HARD&&this.handleNewToken_(a.token.value,a.token.expires)},API.prototype.checkExpiredToken_=function(){if(null!=this.token_){var a=this.token_.expires-(new Date).getTime();TOKEN_RENEW_SOFT>a&&this.refreshAuthToken_({interactive:!1},{nonModal:a>TOKEN_RENEW_HARD})}},API.prototype.expireTokenSoft=function(){if(null==this.token_)throw"No token";this.token_.expires=(new Date).getTime()+TOKEN_RENEW_SOFT/2},API.prototype.expireTokenHard=function(){if(null==this.token_)throw"No token";this.token_.expires=(new Date).getTime()},API.prototype.refreshAuthToken_=function(a,b){this.ticketManager_.refreshTickets(a,b),this.tokenPending_||(this.tokenPending_=!0,this.ticketManager_.getTicket("server").then(function(a){var b=new gss.Context(this.peer_,gss.KRB5_MECHANISM,a,{}),c=b.initSecContext(null);if(!b.isEstablished())throw"Context not established after one message!";var d=a.client.toString();return corsRequest("POST",this.urlBase_+"/v1/auth",{principal:d,token:arrayutils.toBase64(c),createUser:!0}).then(function(a){this.tokenPending_=!1;var b=JSON.parse(a);this.storageManager_.saveToken(d,b.authToken,b.expires)&&this.handleNewToken_(b.authToken,b.expires)}.bind(this))}.bind(this)).then(null,function(a){throw this.tokenPending_=!1,a}.bind(this)))},API.prototype.badToken_=function(a){window.console&&console.log&&console.log("Bad token!"),this.token_&&this.token_.value==a&&(this.token_=null)},API.prototype.getAuthToken_=function(a,b){return this.token_&&this.token_.expires-(new Date).getTime()>TOKEN_RENEW_HARD?Q(this.token_.value):(this.refreshAuthToken_({interactive:a},b),this.tokenDeferred_.promise)},API.prototype.request=function(a,b,c,d,e,f){e=e||{};var g,h=this.getAuthToken_(e.interactive,e.refreshData);return e.withZephyr?(this.ticketManager_.refreshTickets({interactive:e.interactive},e.refreshData),g=this.ticketManager_.getTicket("zephyr")):g=Q(),c=Q(c),d=Q(d),Q.all([h,g,c,d]).then(function(c){var d=c[0],g=c[1],h=c[2],i=c[3],j=this.urlBase_+b+"?access_token="+encodeURIComponent(d);"GET"!=a&&(j+="&clientId="+encodeURIComponent(this.clientId_));for(var k in h)j+="&"+k+"="+encodeURIComponent(h[k]);return e.withZephyr&&(i.credentials=g.toDict()),corsRequest(a,j,i).then(function(a){return JSON.parse(a)},function(c){if(c instanceof HttpError&&401==c.status&&(this.badToken_(d),!f))return this.request(a,b,h,i,!1,!0);throw c}.bind(this))}.bind(this))},API.prototype.get=function(a,b,c){return this.request("GET",a,b,void 0,c)},API.prototype.post=function(a,b,c){return this.request("POST",a,{},b,c)},API.prototype.checkInnerDemon_=function(){this.get("/v1/zephyrcreds").then(function(a){return a.needsRefresh?this.post("/v1/zephyrcreds",{},{withZephyr:!0,refreshData:{nonModal:!0,innerDemon:!0}}):void 0}.bind(this)).then(null,function(a){window.console&&console.error&&console.error("Error checking zephyr creds",a)}.bind(this)).then(function(){window.setTimeout(this.checkInnerDemon_.bind(this),INNER_DEMON_CHECK_TIMER)}.bind(this)).done()},API.prototype.socket=function(){return this.socket_},API.prototype.allocateTailId=function(){return this.nextTailId_++},API.prototype.tryConnectSocket_=function(){this.socket_||this.socketPending_||(this.socketPending_=!0,this.getAuthToken_(!1).then(function(a){var b=new RoostSocket(new SockJS(this.urlBase_+"/v1/socket"));b.sockJS().addEventListener("open",function(){b.send({type:"auth",clientId:this.clientId_,token:a})}.bind(this));var c=!1,d=function(){b.removeEventListener("ready",d),c=!0,this.socketPending_=!1,this.socket_=b,this.reconnectDelay_=RECONNECT_DELAY,this.reconnectTries_=RECONNECT_TRIES,this.dispatchEvent({type:"connect"})}.bind(this);b.addEventListener("ready",d);var e=function(d){b.sockJS().removeEventListener("close",e),window.console&&console.log&&console.log("Disconnected",d),c?(this.dispatchEvent({type:"disconnect"}),this.socket_=null,setTimeout(this.tryConnectSocket_.bind(this),this.reconnectDelay_)):(this.socketPending_=!1,4003==d.code&&this.badToken_(a),this.reconnectDelay_*=2,this.reconnectTries_-->0&&setTimeout(this.tryConnectSocket_.bind(this),this.reconnectDelay_))}.bind(this);b.sockJS().addEventListener("close",e)}.bind(this),function(a){throw this.socketPending_=!1,a}.bind(this)).done())},MessageModel.prototype.newTailInclusive=function(a,b,c){return new MessageTail(this,a,!0,b,c)},MessageModel.prototype.newTail=function(a,b,c){return new MessageTail(this,a,!1,b,c)},MessageModel.prototype.newReverseTail=function(a,b,c){return new MessageReverseTail(this,a,b,c)},MessageModel.prototype.compareMessages=function(a,b){return a.receiveTime-b.receiveTime},MessageTail.prototype.onConnect_=function(){this.onDisconnect_(),this.socket_=this.model_.api_.socket(),this.socket_&&(this.socket_.addEventListener("messages",this.messagesCb_),this.socket_.sockJS().addEventListener("close",this.disconnectCb_),this.createTail_(),this.expandTo(0))},MessageTail.prototype.onDisconnect_=function(){this.socket_&&(this.socket_.removeEventListener("messages",this.messagesCb_),this.socket_.sockJS().removeEventListener("close",this.disconnectCb_),this.socket_=null,this.cb_&&this.cb_([],!1))},MessageTail.prototype.expandTo=function(a){this.messagesWanted_=Math.max(this.messagesWanted_,a-this.messagesSentTotal_);var b=this.messagesWanted_+this.messagesSentRecent_;this.socket_&&this.lastExtend_<b&&(this.socket_.send({type:"extend-tail",id:this.tailId_,count:b}),this.lastExtend_=b)},MessageTail.prototype.close=function(){this.socket_&&this.socket_.send({type:"close-tail",id:this.tailId_}),this.cb_=null,this.model_.api_.removeEventListener("connect",this.connectedCb_),this.onDisconnect_()},MessageTail.prototype.createTail_=function(){if(this.socket_){this.tailId_=this.model_.api_.allocateTailId(),this.messagesSentRecent_=0,this.lastExtend_=0;for(var a={type:"new-tail",id:this.tailId_,start:this.lastSent_,inclusive:this.inclusive_},b=0;b<Filter.FIELDS.length;b++)null!=this.filter_[Filter.FIELDS[b]]&&(a[Filter.FIELDS[b]]=this.filter_[Filter.FIELDS[b]]);this.socket_.send(a)}},MessageTail.prototype.onMessages_=function(a){a.id==this.tailId_&&(a.messages.length&&(this.lastSent_=a.messages[a.messages.length-1].id,this.inclusive_=!1,this.messagesSentTotal_+=a.messages.length,this.messagesSentRecent_+=a.messages.length,this.messagesWanted_-=a.messages.length),this.cb_&&this.cb_(a.messages,a.isDone))},MessageReverseTail.prototype.expandTo=function(a){this.messagesWanted_=Math.max(this.messagesWanted_,a-this.messagesSent_),this.fireRequest_()},MessageReverseTail.prototype.close=function(){this.cb_=null,this.model_.api_.removeEventListener("connect",this.reconnectCb_)},MessageReverseTail.prototype.fireRequest_=function(){if(!this.pending_&&!this.throttleTimer_&&this.cb_&&0!=this.messagesWanted_){var a={reverse:"1",count:String(this.messagesWanted_)};null!=this.start_&&(a.offset=this.start_);for(var b=0;b<Filter.FIELDS.length;b++)null!=this.filter_[Filter.FIELDS[b]]&&(a[Filter.FIELDS[b]]=this.filter_[Filter.FIELDS[b]],"boolean"==typeof a[Filter.FIELDS[b]]&&(a[Filter.FIELDS[b]]=a[Filter.FIELDS[b]]?"1":"0"));this.pending_=!0,this.model_.api_.get("/v1/messages",a).then(function(a){a.messages.reverse(),this.cb_&&this.cb_(a.messages,a.isDone),a.messages.length&&(this.start_=a.messages[0].id),this.messagesSent_+=a.messages.length,this.messagesWanted_-=a.messages.length,this.pending_=!1,this.throttle_=500,a.isDone?this.close():this.fireRequest_()}.bind(this),function(a){this.pending_=!1;var b={disabled:!1};throw window.setTimeout(function(){b.disabled||(this.throttleTimer_=null,this.fireRequest_())}.bind(this),this.throttle_),this.throttleTimer_=b,this.throttle_*=2,a}.bind(this)).done()}},MessageReverseTail.prototype.onReconnect_=function(){this.throttleTimer_&&(this.throttleTimer_.disabled=!0,this.throttleTimer_=null),this.throttle_=500,this.fireRequest_()};var COLOR_MAP={16:"#000000",17:"#00005f",18:"#000087",19:"#0000af",20:"#0000d7",21:"#0000ff",22:"#005f00",23:"#005f5f",24:"#005f87",25:"#005faf",26:"#005fd7",27:"#005fff",28:"#008700",29:"#00875f",30:"#008787",31:"#0087af",32:"#0087d7",33:"#0087ff",34:"#00af00",35:"#00af5f",36:"#00af87",37:"#00afaf",38:"#00afd7",39:"#00afff",40:"#00d700",41:"#00d75f",42:"#00d787",43:"#00d7af",44:"#00d7d7",45:"#00d7ff",46:"#00ff00",47:"#00ff5f",48:"#00ff87",49:"#00ffaf",50:"#00ffd7",51:"#00ffff",52:"#5f0000",53:"#5f005f",54:"#5f0087",55:"#5f00af",56:"#5f00d7",57:"#5f00ff",58:"#5f5f00",59:"#5f5f5f",60:"#5f5f87",61:"#5f5faf",62:"#5f5fd7",63:"#5f5fff",64:"#5f8700",65:"#5f875f",66:"#5f8787",67:"#5f87af",68:"#5f87d7",69:"#5f87ff",70:"#5faf00",71:"#5faf5f",72:"#5faf87",73:"#5fafaf",74:"#5fafd7",75:"#5fafff",76:"#5fd700",77:"#5fd75f",78:"#5fd787",79:"#5fd7af",80:"#5fd7d7",81:"#5fd7ff",82:"#5fff00",83:"#5fff5f",84:"#5fff87",85:"#5fffaf",86:"#5fffd7",87:"#5fffff",88:"#870000",89:"#87005f",90:"#870087",91:"#8700af",92:"#8700d7",93:"#8700ff",94:"#875f00",95:"#875f5f",96:"#875f87",97:"#875faf",98:"#875fd7",99:"#875fff",100:"#878700",101:"#87875f",102:"#878787",103:"#8787af",104:"#8787d7",105:"#8787ff",106:"#87af00",107:"#87af5f",108:"#87af87",109:"#87afaf",110:"#87afd7",111:"#87afff",112:"#87d700",113:"#87d75f",114:"#87d787",115:"#87d7af",116:"#87d7d7",117:"#87d7ff",118:"#87ff00",119:"#87ff5f",120:"#87ff87",121:"#87ffaf",122:"#87ffd7",123:"#87ffff",124:"#af0000",125:"#af005f",126:"#af0087",127:"#af00af",128:"#af00d7",129:"#af00ff",130:"#af5f00",131:"#af5f5f",132:"#af5f87",133:"#af5faf",134:"#af5fd7",135:"#af5fff",136:"#af8700",137:"#af875f",138:"#af8787",139:"#af87af",140:"#af87d7",141:"#af87ff",142:"#afaf00",143:"#afaf5f",144:"#afaf87",145:"#afafaf",146:"#afafd7",147:"#afafff",148:"#afd700",149:"#afd75f",150:"#afd787",151:"#afd7af",152:"#afd7d7",153:"#afd7ff",154:"#afff00",155:"#afff5f",156:"#afff87",157:"#afffaf",158:"#afffd7",159:"#afffff",160:"#d70000",161:"#d7005f",162:"#d70087",163:"#d700af",164:"#d700d7",165:"#d700ff",166:"#d75f00",167:"#d75f5f",168:"#d75f87",169:"#d75faf",170:"#d75fd7",171:"#d75fff",172:"#d78700",173:"#d7875f",174:"#d78787",175:"#d787af",176:"#d787d7",177:"#d787ff",178:"#d7af00",179:"#d7af5f",180:"#d7af87",181:"#d7afaf",182:"#d7afd7",183:"#d7afff",184:"#d7d700",185:"#d7d75f",186:"#d7d787",187:"#d7d7af",188:"#d7d7d7",189:"#d7d7ff",190:"#d7ff00",191:"#d7ff5f",192:"#d7ff87",193:"#d7ffaf",194:"#d7ffd7",195:"#d7ffff",196:"#ff0000",197:"#ff005f",198:"#ff0087",199:"#ff00af",200:"#ff00d7",201:"#ff00ff",202:"#ff5f00",203:"#ff5f5f",204:"#ff5f87",205:"#ff5faf",206:"#ff5fd7",207:"#ff5fff",208:"#ff8700",209:"#ff875f",210:"#ff8787",211:"#ff87af",212:"#ff87d7",213:"#ff87ff",214:"#ffaf00",215:"#ffaf5f",216:"#ffaf87",217:"#ffafaf",218:"#ffafd7",219:"#ffafff",220:"#ffd700",221:"#ffd75f",222:"#ffd787",223:"#ffd7af",224:"#ffd7d7",225:"#ffd7ff",226:"#ffff00",227:"#ffff5f",228:"#ffff87",229:"#ffffaf",230:"#ffffd7",231:"#ffffff",232:"#080808",233:"#121212",234:"#1c1c1c",235:"#262626",236:"#303030",237:"#3a3a3a",238:"#444444",239:"#4e4e4e",240:"#585858",241:"#626262",242:"#6c6c6c",243:"#767676",244:"#808080",245:"#8a8a8a",246:"#949494",247:"#9e9e9e",248:"#a8a8a8",249:"#b2b2b2",250:"#bcbcbc",251:"#c6c6c6",252:"#d0d0d0",253:"#dadada",254:"#e4e4e4",255:"#eeeeee"},OTHERSIDE={"{":["}",/[@}]/g],"(":[")",/[@)]/g],"[":["]",/[@\]]/g],"<":[">",/[@>]/g]},MAX_ZTEXT_DEPTH=32;