"use strict";function RoostEventTarget(){this.listeners_={}}function JobQueue(a){this.queue_=[],this.waiting_=!1,this.callback_=a}function Throttler(a,b){this.timeout_=b||0,this.callback_=a,this.requested_=!1,this.running_=!1,this.throttleTimer_=null,this.nextCall_=Q.defer()}function findUrls(a,b,c){var d,e=0;for(URL_REGEX.lastIndex=0;d=URL_REGEX.exec(a);){var f=URL_REGEX.lastIndex-d[0].length;f>e&&c(a.substring(e,f)),b(d[0]),e=URL_REGEX.lastIndex}e<a.length&&c(a.substring(e))}function StorageManager(){RoostEventTarget.call(this),this.data_=null,this.deferredPrincipal_=Q.defer(),this.expectedPrincipal_=null,this.disabled_=!1,window.addEventListener("storage",this.loadFromStorage_.bind(this)),this.loadFromStorage_()}function webathenaRequest(a,b){var c=Q.defer(),d=WinChan.open({url:a+"/#!request_ticket_v1",relay_url:a+"/relay.html",params:b},function(a,b){return a?(c.reject(a),void 0):"OK"!==b.status?(c.reject(b),void 0):(c.resolve(b.sessions.map(krb.Session.fromDict)),void 0)});return[c.promise,d]}function TicketManager(a,b){RoostEventTarget.call(this),this.webathenaRoot_=a,this.storageManager_=b,this.sessions_=null,this.waitForSession_=Q.defer(),this.pendingRequest_=null,this.storageManager_.addEventListener("change",this.loadFromStorage_.bind(this)),this.loadFromStorage_()}function stringOrNull(a){return null==a?null:String(a)}function boolOrNull(a){return null==a?null:("string"==typeof a&&(a=Number(a)),Boolean(a))}function Filter(a){this.class_key=stringOrNull(a.class_key),this.class_key_base=stringOrNull(a.class_key_base),this.instance_key=stringOrNull(a.instance_key),this.instance_key_base=stringOrNull(a.instance_key_base),this.conversation=stringOrNull(a.conversation),this.recipient=stringOrNull(a.recipient),this.sender=stringOrNull(a.sender),this.is_personal=boolOrNull(a.is_personal)}function UserInfoConflict(){}function UserInfo(a){RoostEventTarget.call(this),this.api_=a,this.base_=null,this.baseVersion_=-1,this.local_=null,this.pending_=null,this.throttler_=new Throttler(this.doUpdate_.bind(this),USER_INFO_UPDATE_THROTTLE),this.ready_=Q.defer(),this.loadInfo_().done()}function NetworkError(a){this.msg=a}function HttpError(a,b,c){this.status=a,this.statusText=b,this.responseText=c}function corsRequest(a,b,c){var d=new XMLHttpRequest;if("withCredentials"in d)d.open(a,b,!0);else{if("undefined"==typeof XDomainRequest)return Q.reject("CORS not supported.");d=new XDomainRequest,d.open(a,b)}var e=Q.defer();return d.onload=function(){200==this.status?e.resolve(this.responseText):this.status?e.reject(new HttpError(this.status,this.statusText,this.responseText)):e.reject(new NetworkError)},d.onerror=function(){e.reject("Request failed")},void 0!==c?(d.setRequestHeader&&d.setRequestHeader("Content-Type","text/plain"),d.send(JSON.stringify(c))):d.send(),e.promise}function RoostSocket(a){RoostEventTarget.call(this),this.sockJS_=a,this.sockJS_.addEventListener("message",this.onMessage_.bind(this)),this.sockJS_.addEventListener("close",this.onClose_.bind(this)),this.ready_=!1,this.pingVisible_=null,this.pingHidden_=null,this.pongTimer_=null,this.onVisibilityChangeCb_=this.onVisibilityChange_.bind(this),document.addEventListener("visibilitychange",this.onVisibilityChangeCb_)}function API(a,b,c,d){RoostEventTarget.call(this),this.urlBase_=a,this.storageManager_=c,this.ticketManager_=d,this.peer_=gss.Name.importName(b,gss.KRB5_NT_PRINCIPAL_NAME),this.token_=null,this.tokenDeferred_=Q.defer(),this.tokenPending_=!1,this.socket_=null,this.socketPending_=!1,this.reconnectDelay_=RECONNECT_DELAY,this.reconnectTries_=RECONNECT_TRIES,this.nextTailId_=1,setTimeout(this.tryConnectSocket_.bind(this),0),this.loadTokenFromStorage_(),this.storageManager_.addEventListener("change",this.loadTokenFromStorage_.bind(this)),this.userInfo_=new UserInfo(this),window.setInterval(this.checkExpiredToken_.bind(this),TOKEN_REFRESH_TIMER),window.addEventListener("online",this.tryConnectSocket_.bind(this))}function MessageModel(a){this.api_=a}function MessageTail(a,b,c,d,e){this.model_=a,this.lastSent_=b,this.inclusive_=c,this.messagesSentTotal_=0,this.messagesSentRecent_=0,this.messagesWanted_=0,this.filter_=d,this.cb_=e,this.tailId_=null,this.lastExtend_=0,this.connectedCb_=this.onConnect_.bind(this),this.disconnectCb_=this.onDisconnect_.bind(this),this.messagesCb_=this.onMessages_.bind(this),this.model_.api_.addEventListener("connect",this.connectedCb_),this.onConnect_()}function MessageReverseTail(a,b,c,d){this.model_=a,this.start_=b,this.messagesSent_=0,this.messagesWanted_=0,this.filter_=c,this.cb_=d,this.pending_=!1,this.throttleTimer_=null,this.throttle_=500,this.reconnectCb_=this.onReconnect_.bind(this),this.model_.api_.addEventListener("connect",this.reconnectCb_)}function nextChar(a,b,c){return c.lastIndex=b,c.test(a)?c.lastIndex-1:-1}function findTagName(a,b){var c=/[a-zA-Z0-9_]*/g;return c.lastIndex=b,c.exec(a)[0]||""}function ZtextNode(a,b,c,d){this.tag=a,this.open=b,this.close=c,this.children=d}function parseZtextHelper(a,b,c,d){function e(a){""!=a&&(f.length&&"string"==typeof f[f.length-1]?f[f.length-1]+=a:f.push(a))}for(var f=[];b<a.length;){var g=nextChar(a,b,c);if(0>g)e(a.substring(b)),b=a.length;else{if(e(a.substring(b,g)),"@"!=a[g]){b=g+1;break}if("@"!=a[g+1]){0>=d&&(e("@"),b++);var h=findTagName(a,g+1),i=a[g+1+h.length];if(i in OTHERSIDE){var j=OTHERSIDE[i][0],k=OTHERSIDE[i][1],l=parseZtextHelper(a,g+1+h.length+1,k,d-1);f.push(new ZtextNode(h,i,j,l.parsed)),b=l.startInd}else e("@"+h),b=g+1+h.length}else e("@"),b=g+2}}return{parsed:f,startInd:b}}function parseZtext(a){return parseZtextHelper(a,0,/@/g,MAX_ZTEXT_DEPTH).parsed}function ztextToDOM(a,b){null==b&&(b=document.createDocumentFragment());for(var c=b,d=0;d<a.length;d++){var e=a[d];if("string"==typeof e)findUrls(e,function(a){var b=document.createElement("a");b.href=a,b.target="_blank",b.rel="nofollow",b.appendChild(document.createTextNode(a)),c.appendChild(b)},function(a){c.appendChild(document.createTextNode(a))});else if(""==e.tag)c.appendChild(ztextToDOM(e.children));else if("b"==e.tag||"bold"==e.tag){var f=document.createElement("b");ztextToDOM(e.children,f),c.appendChild(f)}else if("i"==e.tag||"italic"==e.tag){var f=document.createElement("i");ztextToDOM(e.children,f),c.appendChild(f)}else if("color"==e.tag&&1==e.children.length&&"string"==typeof e.children[0]){var g=e.children[0];g in COLOR_MAP&&(g=COLOR_MAP[g]);var f=document.createElement("span");/^(?:[a-zA-Z]+|#[0-9a-fA-F]{3}|#[0-9a-fA-F]{6})$/.test(g)&&(f.style.color=g),b.appendChild(f),c=f}else c.appendChild(document.createTextNode("@"+e.tag+e.open)),ztextToDOM(e.children,c),c.appendChild(document.createTextNode(e.close))}return b}function clamp(a,b,c){return Math.max(a,Math.min(b,c))}function matchKey(a,b,c){if(a.keyCode!=b)return!1;c=c||{};for(var d=["altKey","altGraphKey","ctrlKey","metaKey","shiftKey"],e=0;e<d.length;e++)if(Boolean(a[d[e]])!=Boolean(c[d[e]]))return!1;return!0}function MessageView(a,b){RoostEventTarget.call(this),this.model_=a,this.container_=b,this.container_.tabIndex=0,this.loadingAbove_=document.createElement("div"),this.loadingAbove_.classList.add("msgview-loading-above");var c=document.createElement("div");c.classList.add("msgview-loading-above-text"),c.textContent="Loading...",this.loadingAbove_.appendChild(c),this.loadingBelow_=document.createElement("div"),this.loadingBelow_.classList.add("msgview-loading-below"),c=document.createElement("div"),c.classList.add("msgview-loading-below-text"),c.textContent="Loading...",this.loadingBelow_.appendChild(c),this.messagesDiv_=document.createElement("div"),this.topMarker_=document.createElement("div"),this.topMarker_.classList.add("msgview-top-marker"),this.container_.appendChild(this.topMarker_),this.container_.appendChild(this.loadingAbove_),this.container_.appendChild(this.messagesDiv_),this.container_.appendChild(this.loadingBelow_),this.tailBelow_=null,this.tailBelowOffset_=0,this.tailAbove_=null,this.tailAboveOffset_=0,this.filter_=new Filter({}),this.checkBuffersPending_=!1,this.reset_(),this.container_.addEventListener("scroll",this.checkBuffers_.bind(this)),this.container_.addEventListener("keydown",this.onKeydown_.bind(this))}function SelectionTracker(a){this.messageView_=a,this.selected_=null,this.selectedMessage_=null,this.messageView_.addEventListener("cachechanged",this.onCacheChanged_.bind(this)),this.messageView_.container().addEventListener("keydown",this.onKeydown_.bind(this))}var CONFIG={realm:"ATHENA.MIT.EDU",server:"https://roost-api.mit.edu",serverPrincipal:"HTTP/roost-api.mit.edu",webathena:"https://webathena.mit.edu"};/*! @source http://purl.eligrey.com/github/classList.js/blob/master/classList.js*/
"undefined"==typeof document||"classList"in document.createElement("a")||function(a){if("HTMLElement"in a||"Element"in a){var b="classList",c="prototype",d=(a.HTMLElement||a.Element)[c],e=Object,f=String[c].trim||function(){return this.replace(/^\s+|\s+$/g,"")},g=Array[c].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},h=function(a,b){this.name=a,this.code=DOMException[a],this.message=b},i=function(a,b){if(""===b)throw new h("SYNTAX_ERR","An invalid or illegal string was specified");if(/\s/.test(b))throw new h("INVALID_CHARACTER_ERR","String contains an invalid character");return g.call(a,b)},j=function(a){for(var b=f.call(a.className),c=b?b.split(/\s+/):[],d=0,e=c.length;e>d;d++)this.push(c[d]);this._updateClassName=function(){a.className=this.toString()}},k=j[c]=[],l=function(){return new j(this)};if(h[c]=Error[c],k.item=function(a){return this[a]||null},k.contains=function(a){return a+="",-1!==i(this,a)},k.add=function(){var a,b=arguments,c=0,d=b.length,e=!1;do a=b[c]+"",-1===i(this,a)&&(this.push(a),e=!0);while(++c<d);e&&this._updateClassName()},k.remove=function(){var a,b=arguments,c=0,d=b.length,e=!1;do{a=b[c]+"";var f=i(this,a);-1!==f&&(this.splice(f,1),e=!0)}while(++c<d);e&&this._updateClassName()},k.toggle=function(a,b){a+="";var c=this.contains(a),d=c?b!==!0&&"remove":b!==!1&&"add";return d&&this[d](a),!c},k.toString=function(){return this.join(" ")},e.defineProperty){var m={get:l,enumerable:!0,configurable:!0};try{e.defineProperty(d,b,m)}catch(n){-2146823252===n.number&&(m.enumerable=!1,e.defineProperty(d,b,m))}}else e[c].__defineGetter__&&d.__defineGetter__(b,l)}}(self),function(){var a,b,c;"undefined"!=typeof document.hidden||("undefined"!=typeof document.mozHidden?(a="mozHidden",b="mozVisibilityState",c="mozvisibilitychange"):"undefined"!=typeof document.webkitHidden&&(a="webkitHidden",b="webkitVisibilityState",c="webkitvisibilitychange")),a&&(Object.defineProperty(document,"hidden",{configurable:!0,enumerable:!0,get:function(){return this[a]}}),Object.defineProperty(document,"visibilityState",{configurable:!0,enumerable:!0,get:function(){return this[b]}}),document.addEventListener(c,function(a){var a=document.createEvent("Event");a.initEvent("visibilitychange",!0,!1),document.dispatchEvent(a)}))}(),RoostEventTarget.prototype.indexOfListener_=function(a,b){if(!(a in this.listeners_))return-1;for(var c=0;c<this.listeners_[a].length;c++)if(this.listeners_[a][c].cb===b)return c;return-1},RoostEventTarget.prototype.addEventListener=function(a,b){a in this.listeners_||(this.listeners_[a]=[]),-1==this.indexOfListener_(a,b)&&this.listeners_[a].push({cb:b,doomed:!1})},RoostEventTarget.prototype.removeEventListener=function(a,b){if(a in this.listeners_){var c=this.indexOfListener_(a,b);-1!=c&&(this.listeners_[a][c].doomed=!0,this.listeners_[a].splice(c,1))}},RoostEventTarget.prototype.dispatchEvent=function(a){var b=a.type;if(b in this.listeners_)for(var c=this.listeners_[b].slice(0),d=0;d<c.length;d++)c[d].doomed||c[d].cb.call(this,a)};var timespan={};timespan.milliseconds=function(a){return a},timespan.seconds=function(a){return 1e3*a},timespan.minutes=function(a){return 1e3*60*a},timespan.hours=function(a){return 1e3*60*60*a},timespan.days=function(a){return 1e3*60*60*24*a},JobQueue.prototype.addJob=function(a){return this.queue_.push(a),this.processQueue_(),this.queue_.length},JobQueue.prototype.processQueue_=function(){if(!this.waiting_&&0!=this.queue_.length){var a=this.queue_[0];this.waiting_=!0,this.callback_(a).then(function(){this.queue_.shift(),this.waiting_=!1,this.processQueue_()}.bind(this)).done()}},Throttler.prototype.processState_=function(){this.requested_&&!this.running_&&null==this.throttleTimer_&&(this.throttleTimer_=setTimeout(function(){this.throttleTimer_=null,this.processState_()}.bind(this),this.timeout_),this.requested_=!1,this.running_=!0,this.nextCall_.resolve(Q.fcall(this.callback_).finally(function(){this.running_=!1,this.processState_()}.bind(this))),this.nextCall_=Q.defer())},Throttler.prototype.request=function(a){return a=a||{},this.requested_=!0,a.noThrottle&&null!=this.throttleTimer_&&(clearTimeout(this.throttleTimer_),this.throttleTimer_=null),setTimeout(this.processState_.bind(this),0),this.nextCall_.promise};var URL_REGEX=new RegExp("\\b(?:https|http):\\/\\/(?:\\[(?:[0-9a-f]{1,4}(?::[0-9a-f]{1,4})*)?(?:::(?:[0-9a-f]{1,4}(?::[0-9a-f]{1,4})*)?)?(?::[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})?\\]|[-a-zA-Z0-9_\\u00a0-\\uefffd]+(?:\\.[-a-zA-Z0-9_\\u00a0-\\uefffd]+)*)(?:/(?:(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))*(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:'\".,<>?«»“”‘’]))?)?","g");StorageManager.prototype=Object.create(RoostEventTarget.prototype),StorageManager.prototype.principalCheck_=function(a){if(null==this.expectedPrincipal_)this.expectedPrincipal_=a,this.deferredPrincipal_.resolve(a);else if(this.expectedPrincipal_!=a)return this.disabled_=!0,this.dispatchEvent({type:"usermismatch",actual:a,expected:this.expectedPrincipal_}),!1;return!0},StorageManager.prototype.loadFromStorage_=function(){var a=localStorage.getItem("roostData");if(a){var b=JSON.parse(a);this.principalCheck_(b.principal)&&(this.data_=b,this.dispatchEvent({type:"change"}))}},StorageManager.prototype.data=function(){return this.data_},StorageManager.prototype.isLoggedIn=function(){return null!=this.expectedPrincipal_},StorageManager.prototype.principal=function(){return this.deferredPrincipal_.promise},StorageManager.prototype.saveTickets=function(a){var b=a.server.client.toString();if(a.zephyr.client.toString()!==b)throw"Zephyr and server tickets don't match!";if(!this.disabled_){var c=this.principalCheck_(b);return this.data_=c?this.data_||{}:{},this.data_.principal=b,this.data_.sessions={server:a.server.toDict(),zephyr:a.zephyr.toDict()},localStorage.setItem("roostData",JSON.stringify(this.data_)),this.dispatchEvent({type:"change"}),c}},StorageManager.prototype.saveToken=function(a,b,c){if(!this.disabled_){var d=this.principalCheck_(a);return this.data_=d?this.data_||{}:{},this.data_.principal=a,this.data_.token={value:b,expires:c},localStorage.setItem("roostData",JSON.stringify(this.data_)),this.dispatchEvent({type:"change"}),d}};var MINIMUM_LIFETIME=timespan.minutes(10);TicketManager.prototype=Object.create(RoostEventTarget.prototype),TicketManager.prototype.loadFromStorage_=function(){var a=this.storageManager_.data();if(a&&a.sessions){var b={server:krb.Session.fromDict(a.sessions.server),zephyr:krb.Session.fromDict(a.sessions.zephyr)};b.server.timeRemaining()<=MINIMUM_LIFETIME||b.zephyr.timeRemaining()<=MINIMUM_LIFETIME||this.handleNewSessions_(b)}},TicketManager.prototype.refreshInteractive_=function(){if(this.pendingRequest_)return this.pendingRequest_.focus(),void 0;var a=webathenaRequest(this.webathenaRoot_,{services:[{principal:["HTTP","roost-api.mit.edu"],realm:CONFIG.realm},{principal:["zephyr","zephyr"],realm:CONFIG.realm}]}),b=a[0],c=a[1];this.pendingRequest_=c,b.then(function(a){this.pendingRequest_=null;var b={server:a[0],zephyr:a[1]};this.storageManager_.saveTickets(b)&&this.handleNewSessions_(b)}.bind(this),function(a){this.pendingRequest_=null,this.dispatchEvent({type:"webathena-error",error:a})}.bind(this)).done()},TicketManager.prototype.handleNewSessions_=function(a){this.sessions_=a,this.waitForSession_.resolve(a),this.waitForSession_=Q.defer()},TicketManager.prototype.getCachedTicket=function(a){return this.sessions_&&this.sessions_[a].timeRemaining()>MINIMUM_LIFETIME?this.sessions_[a]:null},TicketManager.prototype.refreshTickets=function(a,b){a=a||{},b=b||{},(null==this.getCachedTicket("server")||null==this.getCachedTicket("zephyr"))&&(a.interactive?this.refreshInteractive_():setTimeout(function(){this.dispatchEvent({type:"ticket-needed",data:b})}.bind(this)))},TicketManager.prototype.getTicket=function(a){var b=this.getCachedTicket(a);return null!=b?Q(b):this.waitForSession_.promise.then(function(b){return b[a]})};var baseString=function(a){return a.replace(/^(?:un)*/,"").replace(/(?:\.d)*$/,"")};Filter.FIELDS=["class_key","class_key_base","instance_key","instance_key_base","conversation","recipient","sender","is_personal"],Filter.prototype.matchesMessage=function(a){return null!=this.class_key&&this.class_key!==a.classKey?!1:null!=this.class_key_base&&this.class_key_base!==a.classKeyBase?!1:null!=this.instance_key&&this.instance_key!==a.instanceKey?!1:null!=this.instance_key_base&&this.instance_key_base!==a.instanceKeyBase?!1:null!=this.conversation&&this.conversation!==a.conversation?!1:null!=this.recipient&&this.recipient!==a.recipient?!1:null!=this.sender&&this.sender!==a.sender?!1:null!=this.is_personal&&this.is_personal!==a.isPersonal?!1:!0},Filter.prototype.isStricterThan=function(a){if(null!=a.conversation&&this.conversation!==a.conversation)return!1;if(null!=a.recipient&&this.recipient!==a.recipient)return!1;if(null!=a.sender&&this.sender!==a.sender)return!1;if(null!=a.is_personal&&this.is_personal!==a.is_personal)return!1;if(null!=a.class_key&&this.class_key!==a.class_key)return!1;if(null!=a.instance_key&&this.instance_key!==a.instance_key)return!1;if(null!=a.class_key_base)if(null!=this.class_key_base){if(this.class_key_base!==a.class_key_base)return!1}else if(null==this.class_key||baseString(this.class_key)!==a.class_key_base)return!1;if(null!=a.instance_key_base)if(null!=this.instance_key_base){if(this.instance_key_base!==a.instance_key_base)return!1}else if(null==this.instance_key||baseString(this.instance_key)!==a.instance_key_base)return!1;return!0};var USER_INFO_UPDATE_THROTTLE=timespan.seconds(10);UserInfo.prototype=Object.create(RoostEventTarget.prototype),UserInfo.prototype.handleNewInfo_=function(a,b){try{this.base_=JSON.parse(a)}catch(c){window.console&&console.log&&console.log("Error parsing user info",c),this.base_=null}this.baseVersion_=b,Q.isPending(this.ready_.promise)&&this.ready_.resolve(),this.dispatchEvent({type:"change"})},UserInfo.prototype.loadInfo_=function(){return this.api_.get("/v1/info").then(function(a){this.handleNewInfo_(a.info,a.version)}.bind(this))},UserInfo.prototype.ready=function(){return this.ready_.promise},UserInfo.prototype.get=function(a){if(this.baseVersion_<0)throw"User info not loaded!";return this.local_&&a in this.local_?this.local_[a]:this.pending_&&a in this.pending_?this.pending_[a]:"object"==typeof this.base_&&this.base_?this.base_[a]:void 0},UserInfo.prototype.set=function(a,b){if(this.baseVersion_<0)throw"User info not loaded!";this.local_||(this.local_={}),this.local_[a]=b,this.dispatchEvent({type:"change"}),this.throttler_.request()},UserInfo.prototype.mergeLocalAndPending_=function(){for(var a in this.local_)this.local_.hasOwnProperty(a)&&(this.pending_[a]=this.local_[a]);this.local_=this.pending_,this.pending_=null},UserInfo.prototype.doUpdate_=function(){this.pending_=this.local_,this.local_=null;var a={};for(var b in this.base_)this.base_.hasOwnProperty(b)&&(a[b]=this.base_[b]);for(var b in this.pending_)this.pending_.hasOwnProperty(b)&&(a[b]=this.pending_[b]);var c=this.baseVersion_+1,d=JSON.stringify(a);return this.api_.post("/v1/info",{expectedVersion:this.baseVersion_,info:d}).then(function(a){return a.updated?(this.handleNewInfo_(d,c),this.pending_=null,void 0):(this.handleNewInfo_(a.info,a.version),this.mergeLocalAndPending_(),this.doUpdate_())}.bind(this),function(a){throw this.mergeLocalAndPending_(),a}.bind(this))},NetworkError.prototype.toString=function(){return"Network error"},HttpError.prototype.toString=function(){return this.responseText};var SOCKET_PING_TIMER_VISIBLE=timespan.seconds(5),SOCKET_PING_TIMER_HIDDEN=timespan.minutes(1),SOCKET_PONG_TIMEOUT=timespan.seconds(5);"undefined"==typeof document.hidden&&window.console&&console.log&&console.log("Page visibility API not supported."),RoostSocket.prototype=Object.create(RoostEventTarget.prototype),RoostSocket.prototype.sockJS=function(){return this.sockJS_},RoostSocket.prototype.onMessage_=function(a){null!=this.pongTimer_&&(clearTimeout(this.pongTimer_),this.pongTimer_=null);var b=JSON.parse(a.data);"ready"===b.type&&(this.ready_=!0,this.onVisibilityChangeCb_()),this.dispatchEvent(b)},RoostSocket.prototype.send=function(a){this.sockJS_.send(JSON.stringify(a))},RoostSocket.prototype.onVisibilityChange_=function(){this.ready_&&(document.hidden&&null==this.pingHidden_||!document.hidden&&null==this.pingVisible_)&&this.sendPing_()},RoostSocket.prototype.sendPing_=function(){this.send({type:"ping"}),null==this.pongTimer_&&(this.pongTimer_=setTimeout(function(){window.console&&console.log&&console.log("No response from server"),this.sockJS_.close()}.bind(this),SOCKET_PONG_TIMEOUT)),null!=this.pingVisible_&&clearTimeout(this.pingVisible_),this.pingVisible_=setTimeout(function(){this.pingVisible_=null,this.onVisibilityChange_()}.bind(this),SOCKET_PING_TIMER_VISIBLE),null!=this.pingHidden_&&clearTimeout(this.pingHidden_),this.pingHidden_=setTimeout(function(){this.pingHidden_=null,this.onVisibilityChange_()}.bind(this),SOCKET_PING_TIMER_HIDDEN)},RoostSocket.prototype.onClose_=function(){null!=this.pongTimer_&&(clearTimeout(this.pongTimer_),this.pongTimer_=null),null!=this.pingVisible_&&(clearTimeout(this.pingVisible_),this.pingVisible_=null),null!=this.pingHidden_&&(clearTimeout(this.pingHidden_),this.pingHidden_=null),document.removeEventListener("visibilitychange",this.onVisibilityChangeCb_),this.ready_=!1};var RECONNECT_DELAY=timespan.milliseconds(500),RECONNECT_TRIES=10,TOKEN_REFRESH_TIMER=timespan.minutes(30),TOKEN_RENEW_SOFT=timespan.days(1),TOKEN_RENEW_HARD=timespan.minutes(5);API.prototype=Object.create(RoostEventTarget.prototype),API.prototype.userInfo=function(){return this.userInfo_},API.prototype.handleNewToken_=function(a,b){this.token_={value:a,expires:b},this.tokenDeferred_.resolve(a),this.tokenDeferred_=Q.defer()},API.prototype.loadTokenFromStorage_=function(){var a=this.storageManager_.data();a&&a.token&&a.token.expires-(new Date).getTime()>TOKEN_RENEW_HARD&&this.handleNewToken_(a.token.value,a.token.expires)},API.prototype.checkExpiredToken_=function(){if(null!=this.token_){var a=this.token_.expires-(new Date).getTime();TOKEN_RENEW_SOFT>a&&this.refreshAuthToken_({interactive:!1},{nonModal:a>TOKEN_RENEW_HARD})}},API.prototype.refreshAuthToken_=function(a,b){this.ticketManager_.refreshTickets(a,b),this.tokenPending_||(this.tokenPending_=!0,this.ticketManager_.getTicket("server").then(function(a){var b=new gss.Context(this.peer_,gss.KRB5_MECHANISM,a,{}),c=b.initSecContext(null);if(!b.isEstablished())throw"Context not established after one message!";var d=a.client.toString();return corsRequest("POST",this.urlBase_+"/v1/auth",{principal:d,token:arrayutils.toBase64(c),createUser:!0}).then(function(a){this.tokenPending_=!1;var b=JSON.parse(a);this.storageManager_.saveToken(d,b.authToken,b.expires)&&this.handleNewToken_(b.authToken,b.expires)}.bind(this))}.bind(this)).then(null,function(a){throw this.tokenPending_=!1,a}.bind(this)))},API.prototype.badToken_=function(a){window.console&&console.log&&console.log("Bad token!"),this.token_&&this.token_.value==a&&(this.token_=null)},API.prototype.getAuthToken_=function(a){return this.token_&&this.token_.expires-(new Date).getTime()>TOKEN_RENEW_HARD?Q(this.token_.value):(this.refreshAuthToken_({interactive:a}),this.tokenDeferred_.promise)},API.prototype.request=function(a,b,c,d,e,f){e=e||{};var g,h=this.getAuthToken_(e.interactive);return e.withZephyr?(this.ticketManager_.refreshTickets({interactive:!0}),g=this.ticketManager_.getTicket("zephyr")):g=Q(),c=Q(c),d=Q(d),Q.all([h,g,c,d]).then(function(c){var d=c[0],g=c[1],h=c[2],i=c[3],j=this.urlBase_+b+"?access_token="+encodeURIComponent(d);for(var k in h)j+="&"+k+"="+encodeURIComponent(h[k]);return e.withZephyr&&(i.credentials=g.toDict()),corsRequest(a,j,i).then(function(a){return JSON.parse(a)},function(c){if(c instanceof HttpError&&401==c.status&&(this.badToken_(d),!f))return this.request(a,b,h,i,!1,!0);throw c}.bind(this))}.bind(this))},API.prototype.get=function(a,b,c){return this.request("GET",a,b,void 0,c)},API.prototype.post=function(a,b,c){return this.request("POST",a,{},b,c)},API.prototype.socket=function(){return this.socket_},API.prototype.allocateTailId=function(){return this.nextTailId_++},API.prototype.tryConnectSocket_=function(){this.socket_||this.socketPending_||(this.socketPending_=!0,this.getAuthToken_(!1).then(function(a){var b=new RoostSocket(new SockJS(this.urlBase_+"/v1/socket"));b.sockJS().addEventListener("open",function(){b.send({type:"auth",token:a})});var c=!1,d=function(){b.removeEventListener("ready",d),c=!0,this.socketPending_=!1,this.socket_=b,this.reconnectDelay_=RECONNECT_DELAY,this.reconnectTries_=RECONNECT_TRIES,this.dispatchEvent({type:"connect"})}.bind(this);b.addEventListener("ready",d);var e=function(d){b.sockJS().removeEventListener("close",e),window.console&&console.log&&console.log("Disconnected",d),c?(this.dispatchEvent({type:"disconnect"}),this.socket_=null,setTimeout(this.tryConnectSocket_.bind(this),this.reconnectDelay_)):(this.socketPending_=!1,4003==d.code&&this.badToken_(a),this.reconnectDelay_*=2,this.reconnectTries_-->0&&setTimeout(this.tryConnectSocket_.bind(this),this.reconnectDelay_))}.bind(this);b.sockJS().addEventListener("close",e)}.bind(this),function(a){throw this.socketPending_=!1,a}.bind(this)).done())},MessageModel.prototype.newTailInclusive=function(a,b,c){return new MessageTail(this,a,!0,b,c)},MessageModel.prototype.newTail=function(a,b,c){return new MessageTail(this,a,!1,b,c)},MessageModel.prototype.newReverseTail=function(a,b,c){return new MessageReverseTail(this,a,b,c)},MessageModel.prototype.compareMessages=function(a,b){return a.receiveTime-b.receiveTime},MessageTail.prototype.onConnect_=function(){this.onDisconnect_(),this.socket_=this.model_.api_.socket(),this.socket_&&(this.socket_.addEventListener("messages",this.messagesCb_),this.socket_.sockJS().addEventListener("close",this.disconnectCb_),this.createTail_(),this.expandTo(0))},MessageTail.prototype.onDisconnect_=function(){this.socket_&&(this.socket_.removeEventListener("messages",this.messagesCb_),this.socket_.sockJS().removeEventListener("close",this.disconnectCb_),this.socket_=null,this.cb_&&this.cb_([],!1))},MessageTail.prototype.expandTo=function(a){this.messagesWanted_=Math.max(this.messagesWanted_,a-this.messagesSentTotal_);var b=this.messagesWanted_+this.messagesSentRecent_;this.socket_&&this.lastExtend_<b&&(this.socket_.send({type:"extend-tail",id:this.tailId_,count:b}),this.lastExtend_=b)},MessageTail.prototype.close=function(){this.socket_&&this.socket_.send({type:"close-tail",id:this.tailId_}),this.cb_=null,this.model_.api_.removeEventListener("connect",this.connectedCb_),this.onDisconnect_()},MessageTail.prototype.createTail_=function(){if(this.socket_){this.tailId_=this.model_.api_.allocateTailId(),this.messagesSentRecent_=0,this.lastExtend_=0;for(var a={type:"new-tail",id:this.tailId_,start:this.lastSent_,inclusive:this.inclusive_},b=0;b<Filter.FIELDS.length;b++)null!=this.filter_[Filter.FIELDS[b]]&&(a[Filter.FIELDS[b]]=this.filter_[Filter.FIELDS[b]]);this.socket_.send(a)}},MessageTail.prototype.onMessages_=function(a){a.id==this.tailId_&&(a.messages.length&&(this.lastSent_=a.messages[a.messages.length-1].id,this.inclusive_=!1,this.messagesSentTotal_+=a.messages.length,this.messagesSentRecent_+=a.messages.length,this.messagesWanted_-=a.messages.length),this.cb_&&this.cb_(a.messages,a.isDone))},MessageReverseTail.prototype.expandTo=function(a){this.messagesWanted_=Math.max(this.messagesWanted_,a-this.messagesSent_),this.fireRequest_()},MessageReverseTail.prototype.close=function(){this.cb_=null,this.model_.api_.removeEventListener("connect",this.reconnectCb_)},MessageReverseTail.prototype.fireRequest_=function(){if(!this.pending_&&!this.throttleTimer_&&this.cb_&&0!=this.messagesWanted_){var a={reverse:"1",count:String(this.messagesWanted_)};null!=this.start_&&(a.offset=this.start_);for(var b=0;b<Filter.FIELDS.length;b++)null!=this.filter_[Filter.FIELDS[b]]&&(a[Filter.FIELDS[b]]=this.filter_[Filter.FIELDS[b]],"boolean"==typeof a[Filter.FIELDS[b]]&&(a[Filter.FIELDS[b]]=a[Filter.FIELDS[b]]?"1":"0"));this.pending_=!0,this.model_.api_.get("/v1/messages",a).then(function(a){a.messages.reverse(),this.cb_&&this.cb_(a.messages,a.isDone),a.messages.length&&(this.start_=a.messages[0].id),this.messagesSent_+=a.messages.length,this.messagesWanted_-=a.messages.length,this.pending_=!1,this.throttle_=500,a.isDone?this.close():this.fireRequest_()}.bind(this),function(a){this.pending_=!1;var b={disabled:!1};throw window.setTimeout(function(){b.disabled||(this.throttleTimer_=null,this.fireRequest_())}.bind(this),this.throttle_),this.throttleTimer_=b,this.throttle_*=2,a}.bind(this)).done()}},MessageReverseTail.prototype.onReconnect_=function(){this.throttleTimer_&&(this.throttleTimer_.disabled=!0,this.throttleTimer_=null),this.throttle_=500,this.fireRequest_()};var COLOR_MAP={16:"#000000",17:"#00005f",18:"#000087",19:"#0000af",20:"#0000d7",21:"#0000ff",22:"#005f00",23:"#005f5f",24:"#005f87",25:"#005faf",26:"#005fd7",27:"#005fff",28:"#008700",29:"#00875f",30:"#008787",31:"#0087af",32:"#0087d7",33:"#0087ff",34:"#00af00",35:"#00af5f",36:"#00af87",37:"#00afaf",38:"#00afd7",39:"#00afff",40:"#00d700",41:"#00d75f",42:"#00d787",43:"#00d7af",44:"#00d7d7",45:"#00d7ff",46:"#00ff00",47:"#00ff5f",48:"#00ff87",49:"#00ffaf",50:"#00ffd7",51:"#00ffff",52:"#5f0000",53:"#5f005f",54:"#5f0087",55:"#5f00af",56:"#5f00d7",57:"#5f00ff",58:"#5f5f00",59:"#5f5f5f",60:"#5f5f87",61:"#5f5faf",62:"#5f5fd7",63:"#5f5fff",64:"#5f8700",65:"#5f875f",66:"#5f8787",67:"#5f87af",68:"#5f87d7",69:"#5f87ff",70:"#5faf00",71:"#5faf5f",72:"#5faf87",73:"#5fafaf",74:"#5fafd7",75:"#5fafff",76:"#5fd700",77:"#5fd75f",78:"#5fd787",79:"#5fd7af",80:"#5fd7d7",81:"#5fd7ff",82:"#5fff00",83:"#5fff5f",84:"#5fff87",85:"#5fffaf",86:"#5fffd7",87:"#5fffff",88:"#870000",89:"#87005f",90:"#870087",91:"#8700af",92:"#8700d7",93:"#8700ff",94:"#875f00",95:"#875f5f",96:"#875f87",97:"#875faf",98:"#875fd7",99:"#875fff",100:"#878700",101:"#87875f",102:"#878787",103:"#8787af",104:"#8787d7",105:"#8787ff",106:"#87af00",107:"#87af5f",108:"#87af87",109:"#87afaf",110:"#87afd7",111:"#87afff",112:"#87d700",113:"#87d75f",114:"#87d787",115:"#87d7af",116:"#87d7d7",117:"#87d7ff",118:"#87ff00",119:"#87ff5f",120:"#87ff87",121:"#87ffaf",122:"#87ffd7",123:"#87ffff",124:"#af0000",125:"#af005f",126:"#af0087",127:"#af00af",128:"#af00d7",129:"#af00ff",130:"#af5f00",131:"#af5f5f",132:"#af5f87",133:"#af5faf",134:"#af5fd7",135:"#af5fff",136:"#af8700",137:"#af875f",138:"#af8787",139:"#af87af",140:"#af87d7",141:"#af87ff",142:"#afaf00",143:"#afaf5f",144:"#afaf87",145:"#afafaf",146:"#afafd7",147:"#afafff",148:"#afd700",149:"#afd75f",150:"#afd787",151:"#afd7af",152:"#afd7d7",153:"#afd7ff",154:"#afff00",155:"#afff5f",156:"#afff87",157:"#afffaf",158:"#afffd7",159:"#afffff",160:"#d70000",161:"#d7005f",162:"#d70087",163:"#d700af",164:"#d700d7",165:"#d700ff",166:"#d75f00",167:"#d75f5f",168:"#d75f87",169:"#d75faf",170:"#d75fd7",171:"#d75fff",172:"#d78700",173:"#d7875f",174:"#d78787",175:"#d787af",176:"#d787d7",177:"#d787ff",178:"#d7af00",179:"#d7af5f",180:"#d7af87",181:"#d7afaf",182:"#d7afd7",183:"#d7afff",184:"#d7d700",185:"#d7d75f",186:"#d7d787",187:"#d7d7af",188:"#d7d7d7",189:"#d7d7ff",190:"#d7ff00",191:"#d7ff5f",192:"#d7ff87",193:"#d7ffaf",194:"#d7ffd7",195:"#d7ffff",196:"#ff0000",197:"#ff005f",198:"#ff0087",199:"#ff00af",200:"#ff00d7",201:"#ff00ff",202:"#ff5f00",203:"#ff5f5f",204:"#ff5f87",205:"#ff5faf",206:"#ff5fd7",207:"#ff5fff",208:"#ff8700",209:"#ff875f",210:"#ff8787",211:"#ff87af",212:"#ff87d7",213:"#ff87ff",214:"#ffaf00",215:"#ffaf5f",216:"#ffaf87",217:"#ffafaf",218:"#ffafd7",219:"#ffafff",220:"#ffd700",221:"#ffd75f",222:"#ffd787",223:"#ffd7af",224:"#ffd7d7",225:"#ffd7ff",226:"#ffff00",227:"#ffff5f",228:"#ffff87",229:"#ffffaf",230:"#ffffd7",231:"#ffffff",232:"#080808",233:"#121212",234:"#1c1c1c",235:"#262626",236:"#303030",237:"#3a3a3a",238:"#444444",239:"#4e4e4e",240:"#585858",241:"#626262",242:"#6c6c6c",243:"#767676",244:"#808080",245:"#8a8a8a",246:"#949494",247:"#9e9e9e",248:"#a8a8a8",249:"#b2b2b2",250:"#bcbcbc",251:"#c6c6c6",252:"#d0d0d0",253:"#dadada",254:"#e4e4e4",255:"#eeeeee"},OTHERSIDE={"{":["}",/[@}]/g],"(":[")",/[@)]/g],"[":["]",/[@\]]/g],"<":[">",/[@>]/g]},MAX_ZTEXT_DEPTH=32,MIN_BUFFER=50,TARGET_BUFFER=2*MIN_BUFFER,MAX_BUFFER=3*MIN_BUFFER,MAX_ARROW_SCROLL=50,GOAL_RATIO_UP=.25,GOAL_RATIO_DOWN=.6,MARGIN_TOP=20,MARGIN_BELOW=40,SCROLL_PAGE_MARGIN=40,MESSAGE_VIEW_SCROLL_TOP=0,MESSAGE_VIEW_SCROLL_BOTTOM=1;MessageView.prototype=Object.create(RoostEventTarget.prototype),MessageView.prototype.container=function(){return this.container_},MessageView.prototype.cachedMessages=function(){return this.messages_},MessageView.prototype.cachedNodes=function(){return this.nodes_},MessageView.prototype.getCacheIndex=function(a){return a in this.messageToIndex_?this.messageToIndex_[a]-this.listOffset_:null},MessageView.prototype.getNode=function(a){var b=this.getCacheIndex(a);return null==b?null:this.nodes_[b]},MessageView.prototype.getMessage=function(a){var b=this.getCacheIndex(a);return null==b?null:this.messages_[b]},MessageView.prototype.findTopMessage=function(){var a=this.container().getBoundingClientRect(),b=this.cachedNodes();if(0==b.length)return null;for(var c=0,d=b.length-1;d>c;){var e=0|(c+d)/2,f=b[e].getBoundingClientRect();f.top<a.top?c=e+1:d=e}return c>0&&b[c].getBoundingClientRect().top>=a.top+a.height/2&&c--,c},MessageView.prototype.findBottomMessage=function(){var a=this.container().getBoundingClientRect(),b=this.cachedNodes();if(0==b.length)return null;for(var c=0,d=b.length-1;d>c;){var e=0|(c+d+1)/2,f=b[e].getBoundingClientRect();f.bottom<a.bottom?c=e:d=e-1}return c<b.length-2&&b[c].getBoundingClientRect().bottom<=a.top+a.height/2&&c++,c},MessageView.prototype.reset_=function(){this.tailAbove_&&(this.tailAbove_.close(),this.tailAbove_=null),this.tailBelow_&&(this.tailBelow_.close(),this.tailBelow_=null),this.listOffset_=0,this.messages_=[],this.nodes_=[],this.messageToIndex_={},this.messagesDiv_.textContent="",this.pendingCenter_=MESSAGE_VIEW_SCROLL_TOP,this.setAtTop_(!1),this.setAtBottom_(!1),this.loadingBelow_.scrollIntoView()},MessageView.prototype.changeFilter=function(a,b){if(null==b){var c=this.findTopMessage();b=null==c?null:this.messages_[c].id}var d,e,f=this.container_.getBoundingClientRect().top;if(null==b)d=this.loadingBelow_.getBoundingClientRect().top,e=null,b=this.pendingCenter_;else{var g=this.getNode(b);d=null==g?f:g.getBoundingClientRect().top,e=this.getCacheIndex(b)}var h=[],i=[];if(null!=e)if(a.isStricterThan(this.filter_)){for(var j=0;e>j;j++)a.matchesMessage(this.messages_[j])&&h.push(this.messages_[j]);for(var j=e;j<this.messages_.length;j++)a.matchesMessage(this.messages_[j])&&i.push(this.messages_[j])}else a.matchesMessage(this.messages_[e])&&i.push(this.messages_[e]);this.reset_(),this.pendingCenter_=b,this.pendingCenter_===MESSAGE_VIEW_SCROLL_TOP?(this.setAtTop_(!0),this.setAtBottom_(!1)):this.pendingCenter_===MESSAGE_VIEW_SCROLL_BOTTOM&&(this.setAtTop_(!1),this.setAtBottom_(!0)),this.container_.scrollTop=this.loadingBelow_.getBoundingClientRect().top-this.topMarker_.getBoundingClientRect().top-(d-f),this.filter_=a,h.length&&this.prependMessages_(h,!1),i.length&&this.appendMessages_(i,!1),this.checkBuffers_()},MessageView.prototype.scrollToMessage=function(a,b,c){if((void 0==b||void 0==c)&&(c=!0),!b||a in this.messageToIndex_||(this.reset_(),this.appendMessages_([b],!1)),a in this.messageToIndex_){var d=this.nodes_[this.messageToIndex_[a]-this.listOffset_];d.scrollIntoView(c),c||d.getBoundingClientRect().top<this.container_.getBoundingClientRect().top&&d.scrollIntoView(!0)}else this.reset_(),this.pendingCenter_=a,this.checkBuffers_()},MessageView.prototype.scrollToTop=function(){return this.atTop_?(this.container_.scrollTop=0,void 0):(this.reset_(),this.pendingCenter_=MESSAGE_VIEW_SCROLL_TOP,this.setAtTop_(!0),this.setAtBottom_(!1),this.container_.scrollTop=0,this.checkBuffers_(),void 0)},MessageView.prototype.scrollToBottom=function(){return this.atBottom_?(this.container_.scrollTop=this.container_.scrollHeight,void 0):(this.reset_(),this.pendingCenter_=MESSAGE_VIEW_SCROLL_BOTTOM,this.setAtTop_(!1),this.setAtBottom_(!0),this.checkBuffers_(),void 0)},MessageView.prototype.setAtTop_=function(a){this.atTop_!=a&&(this.atTop_=a,this.atTop_?this.loadingAbove_.classList.add("msgview-loading-above-at-end"):this.loadingAbove_.classList.remove("msgview-loading-above-at-end"))},MessageView.prototype.setAtBottom_=function(a){this.atBottom_=a,this.atBottom_?this.loadingBelow_.classList.add("msgview-loading-below-at-end"):this.loadingBelow_.classList.remove("msgview-loading-below-at-end")},MessageView.prototype.saveBottomEdgeScroll_=function(){var a=this.container_.scrollTop,b=this.messagesDiv_.getBoundingClientRect().bottom-this.topMarker_.getBoundingClientRect().top;return a-b},MessageView.prototype.restoreBottomEdgeScroll_=function(a){var b=this.messagesDiv_.getBoundingClientRect().bottom-this.topMarker_.getBoundingClientRect().top;this.container_.scrollTop=b+a},MessageView.prototype.appendMessages_=function(a,b){for(var c=0;c<a.length;c++){var d=this.messages_.length+this.listOffset_;this.messageToIndex_[a[c].id]=d;var e=this.formatMessage_(d,a[c]);this.nodes_.push(e),this.messages_.push(a[c]),this.messagesDiv_.appendChild(e)}this.setAtBottom_(b),this.dispatchEvent({type:"cachechanged"}),this.checkBuffers_()},MessageView.prototype.prependMessages_=function(a,b){for(var c=[],d=this.messagesDiv_.firstChild,e=this.saveBottomEdgeScroll_(),f=0;f<a.length;f++){var g=this.listOffset_-a.length+f;this.messageToIndex_[a[f].id]=g;var h=this.formatMessage_(g,a[f]);c.push(h),this.messagesDiv_.insertBefore(h,d)}this.setAtTop_(b),this.restoreBottomEdgeScroll_(e),this.messages_.unshift.apply(this.messages_,a),this.nodes_.unshift.apply(this.nodes_,c),this.listOffset_-=a.length,this.dispatchEvent({type:"cachechanged"}),this.checkBuffers_()};var COLORS=["black","maroon","red","purple","fuchsia","green","blue"];MessageView.prototype.formatMessage_=function(a,b){var c=document.createElement("pre"),d="   "+b.message.replace(/\s+$/,"").split("\n").join("\n   "),e=document.createElement("a");e.href="#msg-"+b.id,e.textContent="[LINK]";var f=b.number;if(void 0==f){f=0;for(var g=b.classKey+"|"+b.instanceKey,h=0;h<g.length;h++)f=0|(f<<5)-f+g.charCodeAt(h)}var i=b.id,j=b.classKeyBase,k=b.instanceKeyBase;return c.appendChild(e),c.appendChild(document.createTextNode(" ")),b.isPersonal&&"message"==b.classKey?b.isOutgoing?(c.appendChild(document.createTextNode("Zephyr to ")),e=document.createElement("a"),e.textContent=b.recipient,e.addEventListener("click",function(a){a.preventDefault(),this.changeFilter(new Filter({conversation:b.recipient}),i)}.bind(this)),c.appendChild(e),c.appendChild(document.createTextNode(" / ")),e=document.createElement("a"),e.textContent=b.instance,e.addEventListener("click",function(a){a.preventDefault(),this.changeFilter(new Filter({conversation:b.recipient,instance_key_base:k}),i)}.bind(this)),c.appendChild(e),c.appendChild(document.createTextNode("  "+new Date(b.time).toString()+"\n"))):(c.appendChild(document.createTextNode("Zephyr from ")),e=document.createElement("a"),e.textContent=b.sender,e.addEventListener("click",function(a){a.preventDefault(),this.changeFilter(new Filter({conversation:b.sender}),i)}.bind(this)),c.appendChild(e),c.appendChild(document.createTextNode(" / ")),e=document.createElement("a"),e.textContent=b.instance,e.addEventListener("click",function(a){a.preventDefault(),this.changeFilter(new Filter({conversation:b.sender,instance_key_base:k}),i)}.bind(this)),c.appendChild(e),c.appendChild(document.createTextNode("  "+new Date(b.time).toString()+"\n"))):(e=document.createElement("a"),e.textContent=b.class,e.addEventListener("click",function(a){a.preventDefault(),this.changeFilter(new Filter({class_key_base:j}),i)}.bind(this)),c.appendChild(e),c.appendChild(document.createTextNode(" / ")),e=document.createElement("a"),e.textContent=b.instance,e.addEventListener("click",function(a){a.preventDefault(),this.changeFilter(new Filter({class_key_base:j,instance_key_base:k}),i)
}.bind(this)),c.appendChild(e),c.appendChild(document.createTextNode(" / "+b.sender+"  "+new Date(b.time).toString()+"\n"))),c.appendChild(ztextToDOM(parseZtext(d))),c.className="message",c.style.color=COLORS[(f%COLORS.length+COLORS.length)%COLORS.length],c.addEventListener("click",this.onClickMessage_.bind(this,a)),c},MessageView.prototype.checkBelow_=function(a){if(this.nodes_.length<MIN_BUFFER)return 1;var b=this.nodes_[this.nodes_.length-MIN_BUFFER].getBoundingClientRect();return a.bottom>b.top?1:this.nodes_.length<MAX_BUFFER?0:(b=this.nodes_[this.nodes_.length-MAX_BUFFER].getBoundingClientRect(),a.bottom<b.top?-1:0)},MessageView.prototype.checkAbove_=function(a){if(this.nodes_.length<MIN_BUFFER)return 1;var b=this.nodes_[MIN_BUFFER-1].getBoundingClientRect();return a.top<b.bottom?1:this.nodes_.length<MAX_BUFFER?0:(b=this.nodes_[MAX_BUFFER-1].getBoundingClientRect(),a.top>b.bottom?-1:0)},MessageView.prototype.ensureTailAbove_=function(){this.tailAbove_||this.atTop_||(this.messages_.length?(this.tailAbove_=this.model_.newReverseTail(this.messages_[0].id,this.filter_,this.prependMessages_.bind(this)),this.tailAboveOffset_=this.listOffset_):(this.pendingCenter_===MESSAGE_VIEW_SCROLL_TOP||(this.pendingCenter_===MESSAGE_VIEW_SCROLL_BOTTOM?(this.tailAbove_=this.model_.newReverseTail(null,this.filter_,this.prependMessages_.bind(this)),this.tailAboveOffset_=this.listOffset_):(this.tailAbove_=this.model_.newReverseTail(this.pendingCenter_,this.filter_,this.prependMessages_.bind(this)),this.tailAboveOffset_=this.listOffset_)),this.tailAbove_&&this.tailAbove_.expandTo(TARGET_BUFFER)))},MessageView.prototype.ensureTailBelow_=function(){this.tailBelow_||(this.messages_.length?(this.tailBelow_=this.model_.newTail(this.messages_[this.messages_.length-1].id,this.filter_,this.appendMessages_.bind(this)),this.tailBelowOffset_=this.listOffset_+this.messages_.length-1):(this.pendingCenter_===MESSAGE_VIEW_SCROLL_TOP?(this.tailBelow_=this.model_.newTail(null,this.filter_,this.appendMessages_.bind(this)),this.tailBelowOffset_=this.listOffset_):this.pendingCenter_===MESSAGE_VIEW_SCROLL_BOTTOM?this.atTop_&&(this.tailBelow_=this.model_.newTail(null,this.filter_,this.appendMessages_.bind(this)),this.tailBelowOffset_=this.listOffset_):(this.tailBelow_=this.model_.newTailInclusive(this.pendingCenter_,this.filter_,this.appendMessages_.bind(this)),this.tailBelowOffset_=this.listOffset_),this.tailBelow_&&this.tailBelow_.expandTo(TARGET_BUFFER)))},MessageView.prototype.checkBuffers_=function(){this.checkBuffersPending_||(setTimeout(this.checkBuffersReal_.bind(this),0),this.checkBuffersPending_=!0)},MessageView.prototype.checkBuffersReal_=function(){this.checkBuffersPending_=!1;var a=this.container_.getBoundingClientRect(),b=this.checkBelow_(a);if(b>0)this.ensureTailBelow_(),this.tailBelow_&&this.tailBelow_.expandTo(this.listOffset_+this.nodes_.length-1+(TARGET_BUFFER-MIN_BUFFER)-this.tailBelowOffset_);else if(0>b){this.tailBelow_&&(this.tailBelow_.close(),this.tailBelow_=null);for(var c=MAX_BUFFER-TARGET_BUFFER,d=0;c>d;d++){var e=this.nodes_.length-d-1;this.messagesDiv_.removeChild(this.nodes_[e]),delete this.messageToIndex_[this.messages_[e].id]}this.nodes_.splice(this.nodes_.length-c,c),this.messages_.splice(this.messages_.length-c,c),this.setAtBottom_(!1)}var f=this.checkAbove_(a);if(f>0)this.ensureTailAbove_(),this.tailAbove_&&this.tailAbove_.expandTo(this.tailAboveOffset_-(this.listOffset_-(TARGET_BUFFER-MIN_BUFFER)));else if(0>f){this.tailAbove_&&(this.tailAbove_.close(),this.tailAbove_=null);for(var c=MAX_BUFFER-TARGET_BUFFER,g=this.saveBottomEdgeScroll_(),d=0;c>d;d++)this.messagesDiv_.removeChild(this.nodes_[d]),delete this.messageToIndex_[this.messages_[d].id];this.setAtTop_(!1),this.restoreBottomEdgeScroll_(g),this.nodes_.splice(0,c),this.messages_.splice(0,c),this.listOffset_+=c}},MessageView.prototype.onKeydown_=function(a){matchKey(a,36)||matchKey(a,32,{metaKey:1})?(a.preventDefault(),this.scrollToTop()):(matchKey(a,35)||matchKey(a,40,{metaKey:1}))&&(a.preventDefault(),this.scrollToBottom())},MessageView.prototype.onClickMessage_=function(a){this.dispatchEvent({type:"messageclick",cacheIndex:a-this.listOffset_})},SelectionTracker.prototype.getSelectedNode_=function(){return null==this.selected_?null:this.messageView_.getNode(this.selected_)},SelectionTracker.prototype.selectMessage=function(a){if(null!=this.selected_){var b=this.getSelectedNode_();b&&b.classList.remove("message-selected")}this.selected_!=a&&(this.selectedMessage_=null),this.selected_=a,this.onCacheChanged_()},SelectionTracker.prototype.clampSelection_=function(a){if(null!=this.selected_){var b=this.getSelectedNode_();if(b){var c=this.messageView_.container().getBoundingClientRect(),d=b.getBoundingClientRect();if(d.bottom>c.top&&d.top<c.bottom)return!1}}var e=a?this.messageView_.findTopMessage():this.messageView_.findBottomMessage();return null==e?!1:(this.selectMessage(this.messageView_.cachedMessages()[e].id),!0)},SelectionTracker.prototype.adjustSelection_=function(a,b){if(this.clampSelection_(a>0))return!0;if(null==this.selected_)return!1;var c=this.getSelectedNode_();if(null==c)return!1;var d=this.messageView_.container().getBoundingClientRect(),e=c.getBoundingClientRect();if(b){if(a>0&&e.bottom>d.bottom-MARGIN_BELOW)return!1;if(0>a&&e.top<d.top)return!1}var f=this.messageView_.getCacheIndex(this.selected_);if(null==f)return!1;var g=f+a;if(0>g||g>=this.messageView_.cachedNodes().length)return!1;this.selectMessage(this.messageView_.cachedMessages()[g].id);var h=this.messageView_.cachedNodes()[g],i=h.getBoundingClientRect().top-this.messageView_.topMarker_.getBoundingClientRect().top,j=i-(0>a?d.height*GOAL_RATIO_UP:d.height*GOAL_RATIO_DOWN);if(0>a&&this.messageView_.container().scrollTop>j||a>0&&this.messageView_.container().scrollTop<j){var k=this.messageView_.container().scrollTop+a*c.getBoundingClientRect().height,l=clamp(k-MAX_ARROW_SCROLL,j,k+MAX_ARROW_SCROLL);this.messageView_.container().scrollTop=l}return this.ensureSelectionVisible_(),!0},SelectionTracker.prototype.isSelectionVisible=function(){var a=this.messageView_.container().getBoundingClientRect();if(null==this.selectedMessage_)return!1;var b=this.getSelectedNode_();if(null==b)return!1;var c=b.getBoundingClientRect();return c.top<a.top?!1:c.bottom>a.bottom?!1:!0},SelectionTracker.prototype.ensureSelectionVisible_=function(){var a=this.messageView_.container().getBoundingClientRect();if(null!=this.selectedMessage_){var b=this.getSelectedNode_();if(null==b){var c=!0,d=this.messageView_.cachedMessages()[0];return void 0!==d&&(c=this.messageView_.model_.compareMessages(this.selectedMessage_,d)<0),this.messageView_.scrollToMessage(this.selectedMessage_.id,this.selectedMessage_,c),void 0}var e=b.getBoundingClientRect();e.top<a.top?this.messageView_.scrollToMessage(this.selectedMessage_.id,this.selectedMessage_,!0):e.bottom>a.bottom&&this.messageView_.scrollToMessage(this.selectedMessage_.id,this.selectedMessage_,!1)}},SelectionTracker.prototype.onKeydown_=function(a){function b(a,b,c){var d={};return""==a.recipient||"@"==a.recipient[0]?(d.recipient=a.recipient,c?d.class_key_base=a.classKeyBase:d.class_key=a.classKey):d.conversation=a.conversation,b&&(c?d.instance_key_base=a.instanceKeyBase:d.instance_key=a.instanceKey),new Filter(d)}matchKey(a,40)||matchKey(a,74)?this.adjustSelection_(1,40==a.keyCode)&&a.preventDefault():matchKey(a,38)||matchKey(a,75)?this.adjustSelection_(-1,38==a.keyCode)&&a.preventDefault():matchKey(a,78,{altKey:!0})?this.selectedMessage_&&(a.preventDefault(),this.ensureSelectionVisible_(),this.messageView_.changeFilter(b(this.selectedMessage_,!1,!0),this.selectedMessage_.id)):matchKey(a,78,{altKey:!0,shiftKey:!0})?this.selectedMessage_&&(a.preventDefault(),this.ensureSelectionVisible_(),this.messageView_.changeFilter(b(this.selectedMessage_,!0,!0),this.selectedMessage_.id)):matchKey(a,77,{altKey:!0})?this.selectedMessage_&&(a.preventDefault(),this.ensureSelectionVisible_(),this.messageView_.changeFilter(b(this.selectedMessage_,!1,!1),this.selectedMessage_.id)):matchKey(a,77,{altKey:!0,shiftKey:!0})?this.selectedMessage_&&(a.preventDefault(),this.ensureSelectionVisible_(),this.messageView_.changeFilter(b(this.selectedMessage_,!0,!1),this.selectedMessage_.id)):matchKey(a,80,{altKey:!0})?(a.preventDefault(),this.messageView_.changeFilter(new Filter({is_personal:!0}),this.isSelectionVisible()?this.selectedMessage_.id:null)):matchKey(a,86,{shiftKey:!0})&&(a.preventDefault(),this.messageView_.changeFilter(new Filter({}),this.isSelectionVisible()?this.selectedMessage_.id:null))},SelectionTracker.prototype.onCacheChanged_=function(){if(null!=this.selected_){null==this.selectedMessage_&&(this.selectedMessage_=this.messageView_.getMessage(this.selected_));var a=this.getSelectedNode_();a&&a.classList.add("message-selected")}};