/*!
 *
 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 * With parts by Tyler Close
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * With parts by Mark Miller
 * Copyright (C) 2011 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */
!function(a){if("function"==typeof bootstrap)bootstrap("promise",a);else if("object"==typeof exports)module.exports=a();else if("function"==typeof define&&define.amd)define(a);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=a}else Q=a()}(function(){"use strict";function a(a){var b=Function.call;return function(){return b.apply(a,arguments)}}function b(a){return a===Object(a)}function c(a){return"[object StopIteration]"===pb(a)||a instanceof hb}function d(a,b){bb&&b.stack&&"object"==typeof a&&null!==a&&a.stack&&-1===a.stack.indexOf(rb)&&(a.stack=e(a.stack)+"\n"+rb+"\n"+e(b.stack))}function e(a){for(var b=a.split("\n"),c=[],d=0;d<b.length;++d){var e=b[d];h(e)||f(e)||!e||c.push(e)}return c.join("\n")}function f(a){return-1!==a.indexOf("(module.js:")||-1!==a.indexOf("(node.js:")}function g(a){var b=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(a);if(b)return[b[1],Number(b[2])];var c=/at ([^ ]+):(\d+):(?:\d+)$/.exec(a);if(c)return[c[1],Number(c[2])];var d=/.*@(.+):(\d+)$/.exec(a);return d?[d[1],Number(d[2])]:void 0}function h(a){var b=g(a);if(!b)return!1;var c=b[0],d=b[1];return c===db&&d>=fb&&xb>=d}function i(){if(bb)try{throw new Error}catch(a){var b=a.stack.split("\n"),c=b[0].indexOf("@")>0?b[1]:b[2],d=g(c);if(!d)return;return db=d[0],d[1]}}function j(a){return A(a)}function k(){function a(a){b=a,jb(c,function(b,c){eb(function(){a.promiseDispatch.apply(a,c)})},void 0),c=void 0,d=void 0}var b,c=[],d=[],e=mb(k.prototype),f=mb(m.prototype);if(f.promiseDispatch=function(a,e,f){var g=ib(arguments);c?(c.push(g),"when"===e&&f[1]&&d.push(f[1])):eb(function(){b.promiseDispatch.apply(b,g)})},f.valueOf=function(){if(c)return f;var a=n(b);return o(a)&&(b=a),a},j.longStackJumpLimit>0&&bb)try{throw new Error}catch(g){f.stack=g.stack.substring(g.stack.indexOf("\n")+1)}return e.promise=f,e.resolve=function(c){b||a(A(c))},e.fulfill=function(c){b||a(z(c))},e.reject=function(c){b||a(y(c))},e.notify=function(a){b||jb(d,function(b,c){eb(function(){c(a)})},void 0)},e}function l(a){if("function"!=typeof a)throw new TypeError("resolver must be a function.");var b=k();return M(a,b.resolve,b.reject,b.notify).fail(b.reject),b.promise}function m(a,b,c,d,e){void 0===b&&(b=function(a){return y(new Error("Promise does not support operation: "+a))});var f=mb(m.prototype);return f.promiseDispatch=function(c,d,e){var g;try{g=a[d]?a[d].apply(f,e):b.call(f,d,e)}catch(h){g=y(h)}c&&c(g)},c&&(f.valueOf=c),e&&(f.exception=d),f}function n(a){return o(a)?a.valueOf():a}function o(a){return b(a)&&"function"==typeof a.promiseDispatch}function p(a){return b(a)&&"function"==typeof a.then}function q(a){return!r(a)&&!s(a)}function r(a){return!p(n(a))}function s(a){return a=n(a),o(a)&&"exception"in a}function t(){ub||"undefined"==typeof window||window.Touch||!window.console||console.warn("[Q] Unhandled rejection reasons (should be empty):",sb),ub=!0}function u(){for(var a=0;a<sb.length;a++){var b=sb[a];b&&"undefined"!=typeof b.stack?console.warn("Unhandled rejection reason:",b.stack):console.warn("Unhandled rejection reason (no stack):",b)}}function v(){sb.length=0,tb.length=0,ub=!1,vb||(vb=!0,"undefined"!=typeof process&&process.on&&process.on("exit",u))}function w(a,b){vb&&(tb.push(a),sb.push(b),t())}function x(a){if(vb){var b=kb(tb,a);-1!==b&&(tb.splice(b,1),sb.splice(b,1))}}function y(a){var b=m({when:function(b){return b&&x(this),b?b(a):this}},function(){return this},function(){return this},a,!0);return w(b,a),b}function z(a){return m({when:function(){return a},get:function(b){return a[b]},set:function(b,c){a[b]=c},"delete":function(b){delete a[b]},post:function(b,c){return null===b||void 0===b?a.apply(void 0,c):a[b].apply(a,c)},apply:function(b,c){return a.apply(b,c)},keys:function(){return ob(a)}},void 0,function(){return a})}function A(a){return o(a)?a:(a=n(a),p(a)?B(a):z(a))}function B(a){var b=k();return eb(function(){try{a.then(b.resolve,b.reject,b.notify)}catch(c){b.reject(c)}}),b.promise}function C(a){return m({isDef:function(){}},function(b,c){return I(a,b,c)},function(){return n(a)})}function D(a,b,c,e){function f(a){try{return"function"==typeof b?b(a):a}catch(c){return y(c)}}function g(a){if("function"==typeof c){d(a,m);try{return c(a)}catch(b){return y(b)}}return y(a)}function h(a){return"function"==typeof e?e(a):a}var i=k(),l=!1,m=A(a);return eb(function(){m.promiseDispatch(function(a){l||(l=!0,i.resolve(f(a)))},"when",[function(a){l||(l=!0,i.resolve(g(a)))}])}),m.promiseDispatch(void 0,"when",[void 0,function(a){var b,c=!1;try{b=h(a)}catch(d){if(c=!0,!j.onerror)throw d;j.onerror(d)}c||i.notify(b)}]),i.promise}function E(a,b,c){return D(a,function(a){return O(a).then(function(a){return b.apply(void 0,a)},c)},c)}function F(a){return function(){function b(a,b){var g;if(qb){try{g=d[a](b)}catch(h){return y(h)}return g.done?g.value:D(g.value,e,f)}try{g=d[a](b)}catch(h){return c(h)?h.value:y(h)}return D(g,e,f)}var d=a.apply(this,arguments),e=b.bind(b,"send"),f=b.bind(b,"throw");return e()}}function G(a){throw new hb(a)}function H(a){return function(){return E([this,O(arguments)],function(b,c){return a.apply(b,c)})}}function I(a,b,c){var d=k();return eb(function(){A(a).promiseDispatch(d.resolve,b,c)}),d.promise}function J(a){return function(b){var c=ib(arguments,1);return I(b,a,c)}}function K(a,b){var c=ib(arguments,2);return wb(a,b,c)}function L(a,b){return I(a,"apply",[void 0,b])}function M(a){var b=ib(arguments,1);return L(a,b)}function N(a){var b=ib(arguments,1);return function(){var c=b.concat(ib(arguments));return I(a,"apply",[this,c])}}function O(a){return D(a,function(a){var b=0,c=k();return jb(a,function(d,e,f){r(e)?a[f]=n(e):(++b,D(e,function(d){a[f]=d,0===--b&&c.resolve(a)},c.reject))},void 0),0===b&&c.resolve(a),c.promise})}function P(a){return D(a,function(a){return a=lb(a,A),D(O(lb(a,function(a){return D(a,gb,gb)})),function(){return a})})}function Q(a,b){return D(a,void 0,b)}function R(a,b){return D(a,void 0,void 0,b)}function S(a,b){return D(a,function(a){return D(b(),function(){return a})},function(a){return D(b(),function(){return y(a)})})}function T(a,b,c,e){var f=function(b){eb(function(){if(d(b,a),!j.onerror)throw b;j.onerror(b)})},g=b||c||e?D(a,b,c,e):a;"object"==typeof process&&process&&process.domain&&(f=process.domain.bind(f)),Q(g,f)}function U(a,b,c){var d=k(),e=setTimeout(function(){d.reject(new Error(c||"Timed out after "+b+" ms"))},b);return D(a,function(a){clearTimeout(e),d.resolve(a)},function(a){clearTimeout(e),d.reject(a)},d.notify),d.promise}function V(a,b){void 0===b&&(b=a,a=void 0);var c=k();return D(a,void 0,void 0,c.notify),setTimeout(function(){c.resolve(a)},b),c.promise}function W(a,b){var c=ib(b),d=k();return c.push(d.makeNodeResolver()),L(a,c).fail(d.reject),d.promise}function X(a){var b=ib(arguments,1),c=k();return b.push(c.makeNodeResolver()),L(a,b).fail(c.reject),c.promise}function Y(a){var b=ib(arguments,1);return function(){var c=b.concat(ib(arguments)),d=k();return c.push(d.makeNodeResolver()),L(a,c).fail(d.reject),d.promise}}function Z(a,b){var c=ib(arguments,2);return function(){function d(){return a.apply(b,arguments)}var e=c.concat(ib(arguments)),f=k();return e.push(f.makeNodeResolver()),L(d,e).fail(f.reject),f.promise}}function $(a,b,c){var d=ib(c||[]),e=k();return d.push(e.makeNodeResolver()),wb(a,b,d).fail(e.reject),e.promise}function _(a,b){var c=ib(arguments,2),d=k();return c.push(d.makeNodeResolver()),wb(a,b,c).fail(d.reject),d.promise}function ab(a,b){return b?(a.then(function(a){eb(function(){b(null,a)})},function(a){eb(function(){b(a)})}),void 0):a}var bb=!1;try{throw new Error}catch(cb){bb=!!cb.stack}var db,eb,fb=i(),gb=function(){};"function"==typeof setImmediate?eb="undefined"!=typeof window?setImmediate.bind(window):setImmediate:"undefined"!=typeof process&&process.nextTick?eb=process.nextTick:function(){function a(){if(--e,++g>=d){g=0,d*=4;for(var a=f&&Math.min(f-1,d);a>e;)++e,h()}for(;f;){--f,b=b.next;var c=b.task;b.task=void 0,c()}g=0}var b={task:void 0,next:null},c=b,d=2,e=0,f=0,g=0,h=void 0;if(eb=function(a){c=c.next={task:a,next:null},e<++f&&d>e&&(++e,h())},"undefined"!=typeof MessageChannel){var i=new MessageChannel;i.port1.onmessage=a,h=function(){i.port2.postMessage(0)}}else h=function(){setTimeout(a,0)}}();var hb,ib=a(Array.prototype.slice),jb=a(Array.prototype.reduce||function(a,b){var c=0,d=this.length;if(1===arguments.length)for(;;){if(c in this){b=this[c++];break}if(++c>=d)throw new TypeError}for(;d>c;c++)c in this&&(b=a(b,this[c],c));return b}),kb=a(Array.prototype.indexOf||function(a){for(var b=0;b<this.length;b++)if(this[b]===a)return b;return-1}),lb=a(Array.prototype.map||function(a,b){var c=this,d=[];return jb(c,function(e,f,g){d.push(a.call(b,f,g,c))},void 0),d}),mb=Object.create||function(a){function b(){}return b.prototype=a,new b},nb=a(Object.prototype.hasOwnProperty),ob=Object.keys||function(a){var b=[];for(var c in a)nb(a,c)&&b.push(c);return b},pb=a(Object.prototype.toString);hb="undefined"!=typeof ReturnValue?ReturnValue:function(a){this.value=a};var qb;try{new Function("(function* (){ yield 1; })"),qb=!0}catch(cb){qb=!1}j.longStackJumpLimit=1;var rb="From previous event:";j.nextTick=eb,j.defer=k,k.prototype.makeNodeResolver=function(){var a=this;return function(b,c){b?a.reject(b):arguments.length>2?a.resolve(ib(arguments,1)):a.resolve(c)}},j.promise=l,j.makePromise=m,m.prototype.then=function(a,b,c){return D(this,a,b,c)},m.prototype.thenResolve=function(a){return D(this,function(){return a})},m.prototype.thenReject=function(a){return D(this,function(){throw a})},jb(["isFulfilled","isRejected","isPending","dispatch","when","spread","get","set","del","delete","post","send","invoke","keys","fapply","fcall","fbind","all","allResolved","timeout","delay","catch","finally","fail","fin","progress","done","nfcall","nfapply","nfbind","denodeify","nbind","npost","nsend","ninvoke","nodeify"],function(a,b){m.prototype[b]=function(){return j[b].apply(j,[this].concat(ib(arguments)))}},void 0),m.prototype.toSource=function(){return this.toString()},m.prototype.toString=function(){return"[object Promise]"},j.nearer=n,j.isPromise=o,j.isPromiseAlike=p,j.isPending=q,j.isFulfilled=r,j.isRejected=s;var sb=[],tb=[],ub=!1,vb=!0;j.resetUnhandledRejections=v,j.getUnhandledReasons=function(){return sb.slice()},j.stopUnhandledRejectionTracking=function(){v(),"undefined"!=typeof process&&process.on&&process.removeListener("exit",u),vb=!1},v(),j.reject=y,j.fulfill=z,j.resolve=A,j.master=C,j.when=D,j.spread=E,j.async=F,j["return"]=G,j.promised=H,j.dispatch=I,j.dispatcher=J,j.get=J("get"),j.set=J("set"),j["delete"]=j.del=J("delete");var wb=j.post=J("post");j.send=K,j.invoke=K,j.fapply=L,j["try"]=M,j.fcall=M,j.fbind=N,j.keys=J("keys"),j.all=O,j.allResolved=P,j["catch"]=j.fail=Q,j.progress=R,j["finally"]=j.fin=S,j.done=T,j.timeout=U,j.delay=V,j.nfapply=W,j.nfcall=X,j.nfbind=Y,j.denodeify=j.nfbind,j.nbind=Z,j.npost=$,j.nsend=_,j.ninvoke=j.nsend,j.nodeify=ab;var xb=i();return j});